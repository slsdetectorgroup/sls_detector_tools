

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>sls_detector_tools.calibration &mdash; sls_detector_tools pre-alpha documentation</title>
  

  
  
  
  

  

  
  
    

  

  
  
    <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  

  

  
        <link rel="index" title="Index"
              href="../../genindex.html"/>
        <link rel="search" title="Search" href="../../search.html"/>
    <link rel="top" title="sls_detector_tools pre-alpha documentation" href="../../index.html"/>
        <link rel="up" title="Module code" href="../index.html"/> 

  
  <script src="../../_static/js/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav" role="document">

   
  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search">
          

          
            <a href="../../index.html" class="icon icon-home"> sls_detector_tools
          

          
          </a>

          
            
            
              <div class="version">
                pre-alpha
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../functions.html">Functions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../instruments.html">Instruments</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../plot.html">Plotting</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../root_helper.html">PyROOT Helper</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../receiver.html">ZmqReceiver</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">sls_detector_tools</a>
        
      </nav>


      
      <div class="wy-nav-content">
        <div class="rst-content">
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../index.html">Docs</a> &raquo;</li>
        
          <li><a href="../index.html">Module code</a> &raquo;</li>
        
      <li>sls_detector_tools.calibration</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>Source code for sls_detector_tools.calibration</h1><div class="highlight"><pre>
<span></span><span class="c1"># -*- coding: utf-8 -*-</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">The main funtions to record and fit calibration data. An example on how to </span>
<span class="sd">use the functions can be found in **sls_detector_tools/calibration/trim_and</span>
<span class="sd">_calibrate_vrf.py**</span>

<span class="sd">The fitting relies on the routines in sls_cmodule</span>

<span class="sd">.. todo::</span>
<span class="sd">    Should we moved to scaled fits for all detectors?</span>

<span class="sd">&quot;&quot;&quot;</span>
<span class="c1">#ROOT</span>
<span class="kn">import</span> <span class="nn">ROOT</span>
<span class="kn">from</span> <span class="nn">ROOT</span> <span class="k">import</span> <span class="n">TF1</span>
    

<span class="c1">#Python imports</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">matplotlib</span> <span class="k">as</span> <span class="nn">mpl</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">from</span> <span class="nn">matplotlib.backends.backend_pdf</span> <span class="k">import</span> <span class="n">PdfPages</span>
<span class="kn">from</span> <span class="nn">mpl_toolkits.axes_grid1</span> <span class="k">import</span> <span class="n">make_axes_locatable</span>
<span class="kn">import</span> <span class="nn">seaborn</span> <span class="k">as</span> <span class="nn">sns</span>
<span class="kn">from</span> <span class="nn">time</span> <span class="k">import</span> <span class="n">time</span><span class="p">,</span> <span class="n">clock</span>

<span class="c1">#Copy files</span>
<span class="kn">import</span> <span class="nn">shutil</span>

<span class="c1">#sls_detector imports</span>
<span class="kn">from</span> <span class="nn">.</span> <span class="k">import</span> <span class="n">root_helper</span> <span class="k">as</span> <span class="n">r</span>
<span class="kn">from</span> <span class="nn">.</span> <span class="k">import</span> <span class="n">plot</span> <span class="k">as</span> <span class="n">plot</span>
<span class="kn">from</span> <span class="nn">.</span> <span class="k">import</span> <span class="n">utils</span> <span class="k">as</span> <span class="n">u</span>
<span class="kn">from</span> <span class="nn">.</span> <span class="k">import</span> <span class="n">config</span> <span class="k">as</span> <span class="n">cfg</span>
<span class="kn">from</span> <span class="nn">.</span> <span class="k">import</span> <span class="n">function</span>
<span class="kn">from</span> <span class="nn">.</span> <span class="k">import</span> <span class="n">mask</span>
<span class="kn">from</span> <span class="nn">.</span> <span class="k">import</span> <span class="n">io</span> 
<span class="c1">#from . import Dacs</span>
<span class="c1">#from . import mpfit</span>


<span class="n">xrf</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;In&#39;</span><span class="p">:</span><span class="mf">3.29</span><span class="p">,</span><span class="s1">&#39;Ti&#39;</span><span class="p">:</span> <span class="mf">4.5</span><span class="p">,</span> <span class="s1">&#39;Cr&#39;</span><span class="p">:</span> <span class="mf">5.4</span><span class="p">,</span> <span class="s1">&#39;Fe&#39;</span><span class="p">:</span> <span class="mf">6.4</span><span class="p">,</span> <span class="s1">&#39;Cu&#39;</span><span class="p">:</span> <span class="mf">8.02</span><span class="p">,</span> <span class="s1">&#39;Ge&#39;</span><span class="p">:</span> <span class="mf">9.9</span><span class="p">,</span> <span class="s1">&#39;Zr&#39;</span><span class="p">:</span> <span class="mf">15.7</span><span class="p">,</span>
<span class="s1">&#39;Mo&#39;</span> <span class="p">:</span> <span class="mf">17.5</span><span class="p">,</span> <span class="s1">&#39;Ag&#39;</span> <span class="p">:</span> <span class="mf">22.2</span><span class="p">,</span> <span class="s1">&#39;Sn&#39;</span><span class="p">:</span> <span class="mf">25.3</span><span class="p">}</span>
<span class="c1">#xrf = {&#39;In&#39;:3.29,&#39;Ti&#39;: 4.5, &#39;Cr&#39;: 5.4, &#39;Fe&#39;: 6.4, &#39;Cu&#39;: 8.02, &#39;Ge&#39;: 9.9, &#39;Zr&#39;: 15.7,</span>
<span class="c1">#&#39;Mo&#39; : 17.5, &#39;Ag&#39; : 22.2, &#39;In&#39;:24.2, &#39;Sn&#39;: 25.3}</span>


<div class="viewcode-block" id="get_data_fname"><a class="viewcode-back" href="../../sls_detector_tools.html#sls_detector_tools.calibration.get_data_fname">[docs]</a><span class="k">def</span> <span class="nf">get_data_fname</span><span class="p">(</span><span class="n">run_id</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Get the filename of the npz file with the vcmp data. The filename</span>
<span class="sd">    is built from det_id, target and run_id as well as calibration.type.</span>
<span class="sd">    Allows for convenient access during calibration.</span>
<span class="sd">    </span>
<span class="sd">    Parameters</span>
<span class="sd">    ---------</span>
<span class="sd">    run_id: int, optional</span>
<span class="sd">        Used only if requesting a special run_id otherwise fetched from</span>
<span class="sd">        cfg.calibration.run_id</span>
<span class="sd">        </span>
<span class="sd">    Returns</span>
<span class="sd">    ----------</span>
<span class="sd">    fname: str</span>
<span class="sd">        filename including .npz ending</span>
<span class="sd">    </span>
<span class="sd">    Examples </span>
<span class="sd">    -------</span>
<span class="sd">    </span>
<span class="sd">    ::</span>
<span class="sd">        </span>
<span class="sd">        cfg.det_id = T45</span>
<span class="sd">        cfg.run_id = 1</span>
<span class="sd">        cfg.calibration.target = Cr</span>
<span class="sd">        get_data_fname()</span>
<span class="sd">        &gt;&gt; T45_vcmp_CrXRF_1.npz</span>
<span class="sd">    </span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1">#Use the run_id specified in cfg.calibration.run_id</span>
    <span class="k">if</span> <span class="n">run_id</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">run_id</span> <span class="o">=</span> <span class="n">cfg</span><span class="o">.</span><span class="n">calibration</span><span class="o">.</span><span class="n">run_id</span>
        
    <span class="k">if</span> <span class="n">cfg</span><span class="o">.</span><span class="n">calibration</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="s1">&#39;XRF&#39;</span><span class="p">:</span>
        <span class="n">fname</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{:s}</span><span class="s1">_vcmp_</span><span class="si">{:s}</span><span class="s1">XRF_</span><span class="si">{:d}</span><span class="s1">.npz&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">cfg</span><span class="o">.</span><span class="n">det_id</span><span class="p">,</span> <span class="n">cfg</span><span class="o">.</span><span class="n">calibration</span><span class="o">.</span><span class="n">target</span><span class="p">,</span> <span class="n">run_id</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">cfg</span><span class="o">.</span><span class="n">calibration</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="s1">&#39;TP&#39;</span><span class="p">:</span>
        <span class="n">fname</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{:s}</span><span class="s1">_vcmp_tp_</span><span class="si">{:.2f}</span><span class="s1">keV_</span><span class="si">{:d}</span><span class="s1">.npz&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">cfg</span><span class="o">.</span><span class="n">det_id</span><span class="p">,</span> <span class="n">cfg</span><span class="o">.</span><span class="n">calibration</span><span class="o">.</span><span class="n">energy</span><span class="p">,</span> <span class="n">run_id</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">cfg</span><span class="o">.</span><span class="n">calibration</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="s1">&#39;beam&#39;</span><span class="p">:</span>
        <span class="n">fname</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{:s}</span><span class="s1">_vcmp_beam_</span><span class="si">{:.2f}</span><span class="s1">keV_</span><span class="si">{:d}</span><span class="s1">.npz&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">cfg</span><span class="o">.</span><span class="n">det_id</span><span class="p">,</span>  <span class="n">cfg</span><span class="o">.</span><span class="n">calibration</span><span class="o">.</span><span class="n">energy</span><span class="p">,</span> <span class="n">run_id</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">fname</span></div>

<div class="viewcode-block" id="get_fit_fname"><a class="viewcode-back" href="../../sls_detector_tools.html#sls_detector_tools.calibration.get_fit_fname">[docs]</a><span class="k">def</span> <span class="nf">get_fit_fname</span><span class="p">(</span> <span class="n">run_id</span> <span class="o">=</span> <span class="kc">None</span> <span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Get the name of the file containing the fit result. Shares the structure </span>
<span class="sd">    with the data file but ends with **_fit.npy** instead</span>
<span class="sd">    </span>
<span class="sd">    Parameters</span>
<span class="sd">    ---------</span>
<span class="sd">    run_id: int, optional</span>
<span class="sd">        Used only if requesting a special run_id otherwise fetched from</span>
<span class="sd">        cfg.calibration.run_id</span>
<span class="sd">    </span>
<span class="sd">    Returns</span>
<span class="sd">    ---------- </span>
<span class="sd">    fname: str</span>
<span class="sd">            name of the fit file</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">fname</span> <span class="o">=</span> <span class="n">get_data_fname</span><span class="p">(</span> <span class="n">run_id</span> <span class="o">=</span> <span class="n">run_id</span> <span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s1">&#39;.npz&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;_fit.npy&#39;</span>
    <span class="k">return</span> <span class="n">fname</span></div>


<div class="viewcode-block" id="get_tbdata_fname"><a class="viewcode-back" href="../../sls_detector_tools.html#sls_detector_tools.calibration.get_tbdata_fname">[docs]</a><span class="k">def</span> <span class="nf">get_tbdata_fname</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Get the name of the npz file containing the trimbit data. *Note that </span>
<span class="sd">    this file does not have a run_id*</span>
<span class="sd">    </span>
<span class="sd">    </span>
<span class="sd">    Returns</span>
<span class="sd">    ---------- </span>
<span class="sd">    fname: str</span>
<span class="sd">            Name of the file</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">cfg</span><span class="o">.</span><span class="n">calibration</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="s1">&#39;XRF&#39;</span><span class="p">:</span>
        <span class="n">fname</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{:s}</span><span class="s1">_tbscan_</span><span class="si">{:s}</span><span class="s1">XRF_</span><span class="si">{:d}</span><span class="s1">.npz&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">cfg</span><span class="o">.</span><span class="n">det_id</span><span class="p">,</span> <span class="n">cfg</span><span class="o">.</span><span class="n">calibration</span><span class="o">.</span><span class="n">target</span><span class="p">,</span> <span class="n">cfg</span><span class="o">.</span><span class="n">calibration</span><span class="o">.</span><span class="n">run_id</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">cfg</span><span class="o">.</span><span class="n">calibration</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="s1">&#39;TP&#39;</span><span class="p">:</span>
        <span class="n">fname</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{:s}</span><span class="s1">_tbscan_tp_</span><span class="si">{:.2f}</span><span class="s1">keV_</span><span class="si">{:d}</span><span class="s1">.npz&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">cfg</span><span class="o">.</span><span class="n">det_id</span><span class="p">,</span> <span class="n">cfg</span><span class="o">.</span><span class="n">calibration</span><span class="o">.</span><span class="n">energy</span><span class="p">,</span> <span class="n">cfg</span><span class="o">.</span><span class="n">calibration</span><span class="o">.</span><span class="n">run_id</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">cfg</span><span class="o">.</span><span class="n">calibration</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="s1">&#39;beam&#39;</span><span class="p">:</span>
        <span class="n">fname</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{:s}</span><span class="s1">_tbscan_beam_</span><span class="si">{:.2f}</span><span class="s1">keV_</span><span class="si">{:d}</span><span class="s1">.npz&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">cfg</span><span class="o">.</span><span class="n">det_id</span><span class="p">,</span> <span class="n">cfg</span><span class="o">.</span><span class="n">calibration</span><span class="o">.</span><span class="n">energy</span><span class="p">,</span> <span class="n">cfg</span><span class="o">.</span><span class="n">calibration</span><span class="o">.</span><span class="n">run_id</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">fname</span></div>
   
<div class="viewcode-block" id="get_trimbit_fname"><a class="viewcode-back" href="../../sls_detector_tools.html#sls_detector_tools.calibration.get_trimbit_fname">[docs]</a><span class="k">def</span> <span class="nf">get_trimbit_fname</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Get the name of the trimbit files without the file ending. This is </span>
<span class="sd">    because when passed by commandline to the slsDetectorSoftware this then</span>
<span class="sd">    loads trimbits for all modules based on their id.</span>
<span class="sd">    </span>
<span class="sd">    </span>
<span class="sd">    Returns</span>
<span class="sd">    ---------- </span>
<span class="sd">    fname: str</span>
<span class="sd">            Name of the file</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">cfg</span><span class="o">.</span><span class="n">calibration</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="s1">&#39;XRF&#39;</span><span class="p">:</span>
        <span class="n">fname</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{:s}</span><span class="s1">_</span><span class="si">{:s}</span><span class="s1">XRF_</span><span class="si">{:s}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">cfg</span><span class="o">.</span><span class="n">det_id</span><span class="p">,</span> <span class="n">cfg</span><span class="o">.</span><span class="n">calibration</span><span class="o">.</span><span class="n">target</span><span class="p">,</span> <span class="n">cfg</span><span class="o">.</span><span class="n">calibration</span><span class="o">.</span><span class="n">gain</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">cfg</span><span class="o">.</span><span class="n">calibration</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="s1">&#39;TP&#39;</span><span class="p">:</span>
        <span class="n">fname</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{:s}</span><span class="s1">_tb_</span><span class="si">{:.2f}</span><span class="s1">keV_</span><span class="si">{:s}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">cfg</span><span class="o">.</span><span class="n">det_id</span><span class="p">,</span>  <span class="n">cfg</span><span class="o">.</span><span class="n">calibration</span><span class="o">.</span><span class="n">energy</span><span class="p">,</span> <span class="n">cfg</span><span class="o">.</span><span class="n">calibration</span><span class="o">.</span><span class="n">gain</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">cfg</span><span class="o">.</span><span class="n">calibration</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="s1">&#39;beam&#39;</span><span class="p">:</span>
        <span class="n">fname</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{:s}</span><span class="s1">_beam_</span><span class="si">{:.2f}</span><span class="s1">keV_</span><span class="si">{:s}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">cfg</span><span class="o">.</span><span class="n">det_id</span><span class="p">,</span> <span class="n">cfg</span><span class="o">.</span><span class="n">calibration</span><span class="o">.</span><span class="n">energy</span><span class="p">,</span> <span class="n">cfg</span><span class="o">.</span><span class="n">calibration</span><span class="o">.</span><span class="n">gain</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">fname</span>  </div>

<div class="viewcode-block" id="get_vrf_fname"><a class="viewcode-back" href="../../sls_detector_tools.html#sls_detector_tools.calibration.get_vrf_fname">[docs]</a><span class="k">def</span> <span class="nf">get_vrf_fname</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Get the name of the npz file containing the vrf scan data</span>
<span class="sd">    </span>
<span class="sd">    </span>
<span class="sd">    Returns</span>
<span class="sd">    ---------- </span>
<span class="sd">    str</span>
<span class="sd">        Filename</span>
<span class="sd">            </span>
<span class="sd">            </span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">cfg</span><span class="o">.</span><span class="n">calibration</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="s1">&#39;XRF&#39;</span><span class="p">:</span>
        <span class="n">fname</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{:s}</span><span class="s1">_vrf_</span><span class="si">{:s}</span><span class="s1">XRF_</span><span class="si">{:d}</span><span class="s1">.npz&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">cfg</span><span class="o">.</span><span class="n">det_id</span><span class="p">,</span> <span class="n">cfg</span><span class="o">.</span><span class="n">calibration</span><span class="o">.</span><span class="n">target</span><span class="p">,</span> <span class="n">cfg</span><span class="o">.</span><span class="n">calibration</span><span class="o">.</span><span class="n">run_id</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">cfg</span><span class="o">.</span><span class="n">calibration</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="s1">&#39;TP&#39;</span><span class="p">:</span>
        <span class="n">fname</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{:s}</span><span class="s1">_vrf_tp_</span><span class="si">{:.2f}</span><span class="s1">keV_</span><span class="si">{:d}</span><span class="s1">.npz&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">cfg</span><span class="o">.</span><span class="n">det_id</span><span class="p">,</span>  <span class="n">cfg</span><span class="o">.</span><span class="n">calibration</span><span class="o">.</span><span class="n">energy</span><span class="p">,</span> <span class="n">cfg</span><span class="o">.</span><span class="n">calibration</span><span class="o">.</span><span class="n">run_id</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">cfg</span><span class="o">.</span><span class="n">calibration</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="s1">&#39;beam&#39;</span><span class="p">:</span>
        <span class="n">fname</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{:s}</span><span class="s1">_vrf_beam_</span><span class="si">{:.2f}</span><span class="s1">keV_</span><span class="si">{:d}</span><span class="s1">.npz&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">cfg</span><span class="o">.</span><span class="n">det_id</span><span class="p">,</span> <span class="n">cfg</span><span class="o">.</span><span class="n">calibration</span><span class="o">.</span><span class="n">energy</span><span class="p">,</span> <span class="n">cfg</span><span class="o">.</span><span class="n">calibration</span><span class="o">.</span><span class="n">run_id</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">fname</span>           </div>

<div class="viewcode-block" id="get_halfmodule_mask"><a class="viewcode-back" href="../../sls_detector_tools.html#sls_detector_tools.calibration.get_halfmodule_mask">[docs]</a><span class="k">def</span> <span class="nf">get_halfmodule_mask</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Get the masks for all half modules in the detector using the geometry from</span>
<span class="sd">    cfg.geometry</span>
<span class="sd">    </span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    list with slices</span>
<span class="sd">        A list containing slice objects to select each half module</span>
<span class="sd">    </span>
<span class="sd">    Raises</span>
<span class="sd">    -------</span>
<span class="sd">    NotImplementedError</span>
<span class="sd">        If the selected geometry is not supported</span>
<span class="sd">    </span>
<span class="sd">    Examples</span>
<span class="sd">    --------</span>
<span class="sd">    </span>
<span class="sd">    Select a half module from a module ::</span>
<span class="sd">        </span>
<span class="sd">        hm = get_halfmodule_mask()</span>
<span class="sd">        data_from_halfmodule = data[hm[0]]</span>
<span class="sd">    </span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">cfg</span><span class="o">.</span><span class="n">geometry</span> <span class="o">==</span> <span class="s1">&#39;500k&#39;</span><span class="p">:</span>
        <span class="n">a</span> <span class="o">=</span> <span class="n">mask</span><span class="o">.</span><span class="n">eiger500k</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">a</span><span class="o">.</span><span class="n">halfmodule</span>
    <span class="k">elif</span> <span class="n">cfg</span><span class="o">.</span><span class="n">geometry</span> <span class="o">==</span> <span class="s1">&#39;2M&#39;</span><span class="p">:</span>
        <span class="n">a</span>  <span class="o">=</span><span class="n">mask</span><span class="o">.</span><span class="n">eiger2M</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">a</span><span class="o">.</span><span class="n">halfmodule</span>
    <span class="k">elif</span> <span class="n">cfg</span><span class="o">.</span><span class="n">geometry</span> <span class="o">==</span> <span class="s1">&#39;9M&#39;</span><span class="p">:</span>
        <span class="n">a</span> <span class="o">=</span> <span class="n">mask</span><span class="o">.</span><span class="n">eiger9M</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">a</span><span class="o">.</span><span class="n">halfmodule</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s1">&#39;Half module mask doses not exist for the&#39;</span>\
                                  <span class="s1">&#39;selected geometry:&#39;</span><span class="p">,</span> <span class="n">cfg</span><span class="o">.</span><span class="n">geometry</span><span class="p">)</span></div>
        

<div class="viewcode-block" id="setup_detector"><a class="viewcode-back" href="../../sls_detector_tools.html#sls_detector_tools.calibration.setup_detector">[docs]</a><span class="k">def</span> <span class="nf">setup_detector</span><span class="p">(</span> <span class="n">detector</span> <span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Make sure that the detector is in a correct state for calibration.</span>
<span class="sd">    Settings that are applied are taken from the config file:</span>
<span class="sd">    </span>
<span class="sd">    * Number of frames</span>
<span class="sd">    * Period</span>
<span class="sd">    * Exposure time</span>
<span class="sd">    * Dynamic range</span>
<span class="sd">    * clock divider</span>
<span class="sd">    * trimbit used during initial scurve</span>
<span class="sd">    * V_trim</span>
<span class="sd">    * Vrs</span>
<span class="sd">    </span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1">#Exposure</span>
    <span class="n">detector</span><span class="o">.</span><span class="n">set_nframes</span><span class="p">(</span> <span class="n">cfg</span><span class="o">.</span><span class="n">calibration</span><span class="o">.</span><span class="n">nframes</span> <span class="p">)</span>
    <span class="n">detector</span><span class="o">.</span><span class="n">set_period</span><span class="p">(</span> <span class="n">cfg</span><span class="o">.</span><span class="n">calibration</span><span class="o">.</span><span class="n">period</span> <span class="p">)</span>
    <span class="k">if</span> <span class="n">cfg</span><span class="o">.</span><span class="n">calibration</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="s1">&#39;TP&#39;</span><span class="p">:</span>
        <span class="n">detector</span><span class="o">.</span><span class="n">set_exptime</span><span class="p">(</span> <span class="n">cfg</span><span class="o">.</span><span class="n">calibration</span><span class="o">.</span><span class="n">tp_exptime</span> <span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">detector</span><span class="o">.</span><span class="n">set_exptime</span><span class="p">(</span> <span class="n">cfg</span><span class="o">.</span><span class="n">calibration</span><span class="o">.</span><span class="n">exptime</span> <span class="p">)</span>
    
    <span class="c1">#Data format and communication</span>
    <span class="k">if</span> <span class="n">cfg</span><span class="o">.</span><span class="n">calibration</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="s1">&#39;TP&#39;</span><span class="p">:</span>
        <span class="n">detector</span><span class="o">.</span><span class="n">set_dr</span><span class="p">(</span> <span class="n">cfg</span><span class="o">.</span><span class="n">calibration</span><span class="o">.</span><span class="n">tp_dynamic_range</span> <span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">detector</span><span class="o">.</span><span class="n">set_dr</span><span class="p">(</span> <span class="n">cfg</span><span class="o">.</span><span class="n">calibration</span><span class="o">.</span><span class="n">dynamic_range</span> <span class="p">)</span>
        
    <span class="n">detector</span><span class="o">.</span><span class="n">set_clkdivider</span><span class="p">(</span> <span class="n">cfg</span><span class="o">.</span><span class="n">calibration</span><span class="o">.</span><span class="n">clkdivider</span> <span class="p">)</span>
    <span class="k">for</span> <span class="n">flag</span> <span class="ow">in</span> <span class="n">cfg</span><span class="o">.</span><span class="n">calibration</span><span class="o">.</span><span class="n">flags</span><span class="p">:</span>
        <span class="n">detector</span><span class="o">.</span><span class="n">set_flags</span><span class="p">(</span> <span class="n">flag</span> <span class="p">)</span>
    
    <span class="c1">#Trimming</span>
    <span class="n">detector</span><span class="o">.</span><span class="n">set_all_trimbits</span><span class="p">(</span> <span class="n">cfg</span><span class="o">.</span><span class="n">calibration</span><span class="o">.</span><span class="n">trimval</span> <span class="p">)</span>
    <span class="n">detector</span><span class="o">.</span><span class="n">dacs</span><span class="p">[</span><span class="s1">&#39;vtr&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">cfg</span><span class="o">.</span><span class="n">calibration</span><span class="o">.</span><span class="n">vtr</span>
    <span class="n">detector</span><span class="o">.</span><span class="n">dacs</span><span class="p">[</span><span class="s1">&#39;vrs&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">cfg</span><span class="o">.</span><span class="n">calibration</span><span class="o">.</span><span class="n">vrs</span>
    
<span class="c1">#    detector.set_dac(&#39;vthreshold&#39;, cfg.calibration.threshold)    </span>
    
    <span class="n">detector</span><span class="o">.</span><span class="n">set_fwrite</span><span class="p">(</span> <span class="kc">True</span> <span class="p">)</span>
    <span class="n">detector</span><span class="o">.</span><span class="n">set_overwrite</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span></div>
<span class="c1">#    detector.s</span>



<span class="k">def</span> <span class="nf">_vrf_scan</span><span class="p">(</span><span class="n">detector</span><span class="p">,</span> <span class="n">start</span><span class="o">=</span><span class="mi">1500</span><span class="p">,</span> <span class="n">stop</span> <span class="o">=</span> <span class="mi">3800</span><span class="p">,</span> <span class="n">step</span> <span class="o">=</span> <span class="mi">30</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Record a vrf scan for choosing gain before starting to trim. </span>
<span class="sd">    This can be used as a stand alone function but is also used in the</span>
<span class="sd">    :py:meth:`sls_detector.calibration.do_vrf_scan`</span>
<span class="sd">    &quot;&quot;&quot;</span>
     <span class="c1">#Switch to 16bit since we always scan this fast</span>
    <span class="n">dr</span> <span class="o">=</span> <span class="n">detector</span><span class="o">.</span><span class="n">dynamic_range</span>
    <span class="n">detector</span><span class="o">.</span><span class="n">dynamic_range</span> <span class="o">=</span> <span class="mi">16</span>
    <span class="n">fname</span> <span class="o">=</span> <span class="n">get_vrf_fname</span><span class="p">()</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span> <span class="s1">&#39;_</span><span class="si">{:d}</span><span class="s1">.npz&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">cfg</span><span class="o">.</span><span class="n">calibration</span><span class="o">.</span><span class="n">run_id</span><span class="p">))</span>  
    <span class="n">detector</span><span class="o">.</span><span class="n">vthreshold</span> <span class="o">=</span> <span class="n">cfg</span><span class="o">.</span><span class="n">calibration</span><span class="o">.</span><span class="n">threshold</span>  


        
    <span class="c1">#Vrf scan and save npz data to path defined in config</span>
    <span class="n">detector</span><span class="o">.</span><span class="n">scan_dac</span><span class="p">(</span><span class="n">start</span><span class="p">,</span><span class="n">stop</span><span class="p">,</span><span class="n">step</span><span class="p">,</span>
           <span class="n">dac</span> <span class="o">=</span> <span class="s1">&#39;vrf&#39;</span><span class="p">,</span>
           <span class="n">fname</span> <span class="o">=</span> <span class="n">fname</span><span class="p">,</span>
           <span class="n">run_id</span> <span class="o">=</span> <span class="n">cfg</span><span class="o">.</span><span class="n">calibration</span><span class="o">.</span><span class="n">run_id</span><span class="p">,</span>
           <span class="n">exptime</span> <span class="o">=</span> <span class="n">cfg</span><span class="o">.</span><span class="n">calibration</span><span class="o">.</span><span class="n">vrf_scan_exptime</span><span class="p">,</span>
           <span class="n">vcp</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
           <span class="n">npz</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
           <span class="n">plot</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span>


    <span class="c1">#Reset dr</span>
    <span class="n">detector</span><span class="o">.</span><span class="n">dynamic_range</span> <span class="o">=</span> <span class="n">dr</span>

<div class="viewcode-block" id="do_vrf_scan"><a class="viewcode-back" href="../../sls_detector_tools.html#sls_detector_tools.calibration.do_vrf_scan">[docs]</a><span class="k">def</span> <span class="nf">do_vrf_scan</span><span class="p">(</span><span class="n">detector</span><span class="p">,</span> <span class="n">xraybox</span><span class="p">,</span> <span class="n">pixelmask</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> 
                <span class="n">start</span> <span class="o">=</span> <span class="mi">1500</span><span class="p">,</span> 
                <span class="n">stop</span> <span class="o">=</span> <span class="mi">3800</span><span class="p">,</span> 
                <span class="n">step</span> <span class="o">=</span> <span class="mi">30</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Does a vrf scan and fits the differential of the scurve for each halfmodule</span>
<span class="sd">    in the detector system. </span>
<span class="sd">    </span>
<span class="sd">    .. todo::</span>
<span class="sd">        Check the multi module system support</span>
<span class="sd">        </span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    detector: SlsDetector</span>
<span class="sd">        The detector that should be scanned</span>
<span class="sd">    xraybox: XrayBox or DummyBox</span>
<span class="sd">        Used for selecting the right target and controlling the shutter</span>
<span class="sd">    pixelmask: np_array(bool), optional</span>
<span class="sd">        Numpy array of bools of the same size and one frame or None to disable</span>
<span class="sd">    start: int, optional</span>
<span class="sd">        start value of the scan</span>
<span class="sd">    stop: int, optional </span>
<span class="sd">        end value of the scan</span>
<span class="sd">    step: int, optional </span>
<span class="sd">        stepsize</span>
<span class="sd">    </span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    vrf: list</span>
<span class="sd">        list of vrf values for each half module</span>
<span class="sd">        </span>
<span class="sd">        </span>
<span class="sd">    &quot;&quot;&quot;</span>   
    
    <span class="c1">#Switch to 16bit since we always scan this fast</span>
<span class="c1">#    dr = detector.get_dr()</span>
<span class="c1">#    detector.set_dr( 16 )</span>
<span class="c1">#    </span>
<span class="c1">#    fname = get_vrf_fname().strip( &#39;_{:d}.npz&#39;.format(cfg.calibration.run_id))  </span>
<span class="c1">#    </span>
<span class="c1">#    detector.set_threshold( cfg.calibration.threshold )  </span>
<span class="c1">#    detector.dacs[&#39;vcp&#39;] = cfg.calibration.threshold</span>
    
    <span class="n">xraybox</span><span class="o">.</span><span class="n">target</span><span class="p">(</span> <span class="n">cfg</span><span class="o">.</span><span class="n">calibration</span><span class="o">.</span><span class="n">target</span> <span class="p">)</span>
    <span class="n">colors</span> <span class="o">=</span> <span class="n">sns</span><span class="o">.</span><span class="n">color_palette</span><span class="p">(</span>  <span class="n">n_colors</span> <span class="o">=</span> <span class="n">cfg</span><span class="o">.</span><span class="n">nmod</span> <span class="p">)</span>
    <span class="n">hostnames</span> <span class="o">=</span> <span class="n">detector</span><span class="o">.</span><span class="n">get_hostname</span><span class="p">()</span>    
    
        
    <span class="c1">#Vrf scan and save npz data to path defined in config</span>
    <span class="n">xraybox</span><span class="o">.</span><span class="n">shutter</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">take_vrf_data</span><span class="p">(</span><span class="n">detector</span><span class="p">,</span> <span class="n">start</span><span class="p">,</span> <span class="n">stop</span><span class="p">,</span> <span class="n">step</span><span class="p">)</span>
    <span class="n">xraybox</span><span class="o">.</span><span class="n">shutter</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>     
     
    <span class="c1">#Load data to do fitting</span>
    <span class="n">fname</span> <span class="o">=</span> <span class="n">get_vrf_fname</span><span class="p">()</span>
    <span class="n">pathname</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span> <span class="n">cfg</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">fname</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span> <span class="n">pathname</span> <span class="p">)</span>
    <span class="k">with</span> <span class="n">np</span><span class="o">.</span><span class="n">load</span><span class="p">(</span> <span class="n">pathname</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">f</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">]</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">f</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">]</span> 
 

    <span class="c1">#Set pixels that are True in the mask to zero for all scan steps</span>
    <span class="k">if</span> <span class="n">pixelmask</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span> <span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="p">):</span>
            <span class="n">data</span><span class="p">[:,:,</span><span class="n">i</span><span class="p">][</span><span class="n">pixelmask</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
   


    
    <span class="n">vrf</span> <span class="o">=</span> <span class="p">[]</span>
    
    <span class="k">if</span> <span class="n">cfg</span><span class="o">.</span><span class="n">calibration</span><span class="o">.</span><span class="n">plot</span><span class="p">:</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
        <span class="n">xx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="n">x</span><span class="o">.</span><span class="n">max</span><span class="p">(),</span> <span class="mi">300</span><span class="p">)</span>
    
    
    <span class="n">halfmodule</span> <span class="o">=</span> <span class="n">get_halfmodule_mask</span><span class="p">()</span>
    
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span> <span class="nb">len</span><span class="p">(</span><span class="n">halfmodule</span><span class="p">)</span> <span class="p">):</span>
        <span class="n">y</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">halfmodule</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span> <span class="o">=</span> <span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span> <span class="o">=</span> <span class="mi">0</span><span class="p">)</span>
        <span class="n">yd</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">gradient</span><span class="p">(</span> <span class="n">y</span> <span class="p">)</span>
        <span class="n">center</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span> <span class="n">yd</span> <span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span> <span class="n">center</span> <span class="p">)</span>
        <span class="k">if</span> <span class="n">center</span> <span class="o">&gt;</span> <span class="mi">75</span><span class="p">:</span>
            <span class="n">xmin</span> <span class="o">=</span> <span class="n">x</span><span class="p">[</span><span class="mi">72</span><span class="p">]</span>
            <span class="n">xmax</span> <span class="o">=</span> <span class="n">x</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">xmin</span> <span class="o">=</span> <span class="n">x</span><span class="p">[</span><span class="n">center</span><span class="o">-</span><span class="mi">4</span><span class="p">]</span>
            <span class="n">xmax</span> <span class="o">=</span> <span class="n">x</span><span class="p">[</span><span class="n">center</span><span class="o">+</span><span class="mi">3</span><span class="p">]</span>
            <span class="nb">print</span><span class="p">(</span> <span class="n">xmin</span><span class="p">,</span> <span class="n">xmax</span> <span class="p">)</span>
        
        <span class="c1">#Graph and fit function</span>
        <span class="n">c</span><span class="p">,</span><span class="n">h</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">yd</span><span class="p">)</span>
        <span class="n">func</span> <span class="o">=</span> <span class="n">TF1</span><span class="p">(</span><span class="s1">&#39;func&#39;</span><span class="p">,</span> <span class="s1">&#39;gaus&#39;</span><span class="p">,</span> <span class="n">xmin</span><span class="p">,</span> <span class="n">xmax</span><span class="p">)</span>
        <span class="n">fit</span> <span class="o">=</span> <span class="n">h</span><span class="o">.</span><span class="n">Fit</span><span class="p">(</span><span class="s1">&#39;func&#39;</span><span class="p">,</span> <span class="s1">&#39;SQR&#39;</span><span class="p">)</span>        

        
        <span class="n">par</span> <span class="o">=</span> <span class="p">[</span> <span class="n">fit</span><span class="o">.</span><span class="n">Get</span><span class="p">()</span><span class="o">.</span><span class="n">Parameter</span><span class="p">(</span><span class="n">j</span><span class="p">)</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">func</span><span class="o">.</span><span class="n">GetNpar</span><span class="p">())</span> <span class="p">]</span>
        
        <span class="k">if</span> <span class="n">cfg</span><span class="o">.</span><span class="n">calibration</span><span class="o">.</span><span class="n">plot</span><span class="p">:</span>
            <span class="n">y_fit</span> <span class="o">=</span> <span class="n">function</span><span class="o">.</span><span class="n">gaus</span><span class="p">(</span><span class="n">xx</span><span class="p">,</span> <span class="o">*</span><span class="n">par</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="s1">&#39;o&#39;</span><span class="p">,</span> <span class="n">color</span> <span class="o">=</span> <span class="n">colors</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">label</span> <span class="o">=</span> <span class="n">hostnames</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span> <span class="o">=</span> <span class="s1">&#39;upper left&#39;</span><span class="p">)</span>
            
            <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">yd</span><span class="p">,</span> <span class="s1">&#39;o&#39;</span><span class="p">,</span> <span class="n">color</span> <span class="o">=</span> <span class="n">colors</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">label</span> <span class="o">=</span> <span class="n">hostnames</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">xx</span><span class="p">,</span> <span class="n">y_fit</span><span class="p">,</span> <span class="n">color</span> <span class="o">=</span> <span class="n">colors</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span> <span class="o">=</span> <span class="s1">&#39;upper left&#39;</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">xlim</span><span class="p">(</span><span class="n">xmin</span><span class="o">-</span><span class="mi">100</span><span class="p">,</span> <span class="n">xmax</span><span class="o">+</span><span class="mi">100</span><span class="p">)</span>
            
    
        
        <span class="n">vrf</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="nb">int</span><span class="p">(</span> <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span> <span class="n">fit</span><span class="o">.</span><span class="n">Get</span><span class="p">()</span><span class="o">.</span><span class="n">Parameter</span><span class="p">(</span><span class="mi">1</span><span class="p">)))</span> <span class="p">)</span>
    
    <span class="k">if</span> <span class="n">cfg</span><span class="o">.</span><span class="n">calibration</span><span class="o">.</span><span class="n">plot</span><span class="p">:</span>
        <span class="n">c</span><span class="o">.</span><span class="n">Draw</span><span class="p">()</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">cfg</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">get_vrf_fname</span><span class="p">()</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s1">&#39;.npz&#39;</span><span class="p">))</span> <span class="p">)</span>

    <span class="c1">#Save data again adding vrf?</span>
    <span class="n">detector</span><span class="o">.</span><span class="n">set_dr</span><span class="p">(</span> <span class="n">dr</span> <span class="p">)</span>
    
    
    <span class="k">return</span> <span class="n">vrf</span>  </div>
    

<div class="viewcode-block" id="find_mean_and_set_vcmp"><a class="viewcode-back" href="../../sls_detector_tools.html#sls_detector_tools.calibration.find_mean_and_set_vcmp">[docs]</a><span class="k">def</span> <span class="nf">find_mean_and_set_vcmp</span><span class="p">(</span><span class="n">detector</span><span class="p">,</span> <span class="n">fit_result</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Find the mean value of the inflection point per chip and set the **Vcmp**</span>
<span class="sd">    of that chip to the right value</span>
<span class="sd">    </span>
<span class="sd">    .. todo::</span>
<span class="sd">        Merge to one code for all geomtetries</span>
<span class="sd">    </span>
<span class="sd">    Supported geometries</span>
<span class="sd">     </span>
<span class="sd">    * 250k</span>
<span class="sd">    * 500k</span>
<span class="sd">    * 2M</span>
<span class="sd">    * 9M</span>
<span class="sd">    </span>
<span class="sd">    Parameters</span>
<span class="sd">    ---------</span>
<span class="sd">    detector: SlsDetector</span>
<span class="sd">        The detector that should be used. Can be None to skip the set dac </span>
<span class="sd">        part and only return values</span>
<span class="sd">    fit_result: numpy_array</span>
<span class="sd">        An array with the result of the per pixel scurve fit</span>
<span class="sd">        </span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    vcmp: list</span>
<span class="sd">        vcmp for each chip</span>
<span class="sd">    vcp: list</span>
<span class="sd">        vcp for each half module</span>
<span class="sd">    lines: list</span>
<span class="sd">        list of lines that can be used with the sls_detector_put</span>
<span class="sd">    </span>

<span class="sd">    </span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1">#Mean value for each chip to be used as threshold during scan    </span>
    <span class="n">mean</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span> <span class="n">cfg</span><span class="o">.</span><span class="n">nmod</span><span class="o">*</span><span class="mi">4</span> <span class="p">)</span>
    
    <span class="c1">#Find the mean values for both module and half module</span>
    <span class="k">if</span> <span class="n">cfg</span><span class="o">.</span><span class="n">geometry</span> <span class="o">==</span> <span class="s1">&#39;quad&#39;</span><span class="p">:</span>
        <span class="c1">#Half module</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">1</span><span class="p">):</span>
            <span class="n">m</span> <span class="o">=</span> <span class="n">fit_result</span><span class="p">[</span><span class="s1">&#39;mu&#39;</span><span class="p">][</span><span class="n">mask</span><span class="o">.</span><span class="n">chip</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span>
            <span class="n">th</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span> <span class="n">m</span><span class="p">[(</span><span class="n">m</span><span class="o">&gt;</span><span class="mi">10</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">m</span><span class="o">&lt;</span><span class="mi">1990</span><span class="p">)]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span> <span class="p">)</span>
            <span class="n">detector</span><span class="o">.</span><span class="n">set_dac</span><span class="p">(</span><span class="n">mask</span><span class="o">.</span><span class="n">vcmp</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">4</span><span class="p">],</span> <span class="n">th</span><span class="p">)</span>
            <span class="n">mean</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="n">th</span>
            
        <span class="n">vcp0</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span> <span class="n">mean</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">4</span><span class="p">][</span><span class="n">mean</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">4</span><span class="p">]</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span> <span class="p">)</span>
        <span class="n">detector</span><span class="o">.</span><span class="n">set_dac</span><span class="p">(</span><span class="s1">&#39;0:vcp&#39;</span><span class="p">,</span> <span class="n">vcp0</span><span class="p">)</span>
        
    <span class="k">elif</span> <span class="n">cfg</span><span class="o">.</span><span class="n">geometry</span> <span class="o">==</span> <span class="s1">&#39;500k&#39;</span><span class="p">:</span>
        <span class="c1">#Module</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span> <span class="n">cfg</span><span class="o">.</span><span class="n">nmod</span><span class="o">*</span><span class="mi">4</span> <span class="p">):</span>
            <span class="n">m</span> <span class="o">=</span> <span class="n">fit_result</span><span class="p">[</span><span class="s1">&#39;mu&#39;</span><span class="p">][</span><span class="n">mask</span><span class="o">.</span><span class="n">chip</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">th</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span> <span class="n">m</span><span class="p">[(</span><span class="n">m</span><span class="o">&gt;</span><span class="mi">100</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">m</span><span class="o">&lt;</span><span class="mi">1900</span><span class="p">)]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span> <span class="p">)</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="n">th</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">detector</span><span class="o">.</span><span class="n">set_dac</span><span class="p">(</span><span class="n">mask</span><span class="o">.</span><span class="n">vcmp</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">th</span><span class="p">)</span>
            <span class="n">mean</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">th</span>
    
        <span class="n">vcp0</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span> <span class="n">mean</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">4</span><span class="p">][</span><span class="n">mean</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">4</span><span class="p">]</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span> <span class="p">)</span>
        <span class="n">vcp1</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span> <span class="n">mean</span><span class="p">[</span><span class="mi">4</span><span class="p">:][</span><span class="n">mean</span><span class="p">[</span><span class="mi">4</span><span class="p">:]</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span> <span class="p">)</span>
        <span class="n">detector</span><span class="o">.</span><span class="n">set_dac</span><span class="p">(</span><span class="s1">&#39;0:vcp&#39;</span><span class="p">,</span> <span class="n">vcp0</span><span class="p">)</span>
        <span class="n">detector</span><span class="o">.</span><span class="n">set_dac</span><span class="p">(</span><span class="s1">&#39;1:vcp&#39;</span><span class="p">,</span> <span class="n">vcp1</span><span class="p">)</span>
        
    <span class="k">elif</span> <span class="n">cfg</span><span class="o">.</span><span class="n">geometry</span> <span class="o">==</span> <span class="s1">&#39;2M&#39;</span><span class="p">:</span>
        <span class="c1">#Module stuff</span>
        <span class="n">vcmp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">mask</span><span class="o">.</span><span class="n">eiger2M</span><span class="o">.</span><span class="n">module</span><span class="p">),</span> <span class="mi">8</span><span class="p">)</span> <span class="p">)</span>
        <span class="n">vcp</span>  <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">mask</span><span class="o">.</span><span class="n">eiger2M</span><span class="o">.</span><span class="n">module</span><span class="p">),</span> <span class="mi">2</span><span class="p">)</span> <span class="p">)</span>
        
        <span class="k">for</span> <span class="n">j</span><span class="p">,</span><span class="n">mod</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span> <span class="n">mask</span><span class="o">.</span><span class="n">eiger2M</span><span class="o">.</span><span class="n">module</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span> <span class="mi">8</span> <span class="p">):</span>
                <span class="n">m</span> <span class="o">=</span> <span class="n">fit_result</span><span class="p">[</span><span class="s1">&#39;mu&#39;</span><span class="p">][</span><span class="n">mod</span><span class="p">][</span><span class="n">mask</span><span class="o">.</span><span class="n">chip</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">th</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span> <span class="n">m</span><span class="p">[(</span><span class="n">m</span><span class="o">&gt;</span><span class="mi">10</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">m</span><span class="o">&lt;</span><span class="mi">1990</span><span class="p">)]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span> <span class="p">)</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="n">th</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="n">vcmp</span><span class="p">[</span><span class="n">j</span><span class="p">,</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">th</span>
                
                <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">detector</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">type</span><span class="p">(</span> <span class="kc">None</span> <span class="p">):</span>
                    <span class="n">detector</span><span class="o">.</span><span class="n">set_dac</span><span class="p">(</span><span class="n">mask</span><span class="o">.</span><span class="n">eiger2M</span><span class="o">.</span><span class="n">vcmp</span><span class="p">[</span><span class="n">j</span><span class="o">*</span><span class="mi">8</span><span class="o">+</span><span class="n">i</span><span class="p">],</span> <span class="n">th</span><span class="p">)</span>
                    
                <span class="n">mean</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">th</span>
        
            <span class="n">vcp0</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span> <span class="n">mean</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">4</span><span class="p">][</span><span class="n">mean</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">4</span><span class="p">]</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span> <span class="p">)</span>
            <span class="n">vcp1</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span> <span class="n">mean</span><span class="p">[</span><span class="mi">4</span><span class="p">:][</span><span class="n">mean</span><span class="p">[</span><span class="mi">4</span><span class="p">:]</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span> <span class="p">)</span>
            <span class="n">vcp</span><span class="p">[</span><span class="n">j</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">vcp0</span>
            <span class="n">vcp</span><span class="p">[</span><span class="n">j</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">vcp1</span>
            
            <span class="k">if</span> <span class="nb">type</span><span class="p">(</span> <span class="n">detector</span> <span class="p">)</span> <span class="o">!=</span> <span class="nb">type</span><span class="p">(</span><span class="kc">None</span><span class="p">):</span>
                <span class="n">detector</span><span class="o">.</span><span class="n">set_dac</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{:d}</span><span class="s1">:vcp&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">j</span><span class="o">*</span><span class="mi">2</span><span class="p">),</span> <span class="n">vcp0</span><span class="p">)</span>
                <span class="n">detector</span><span class="o">.</span><span class="n">set_dac</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{:d}</span><span class="s1">:vcp&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">j</span><span class="o">*</span><span class="mi">2</span><span class="o">+</span><span class="mi">1</span><span class="p">),</span> <span class="n">vcp1</span><span class="p">)</span>  


    <span class="k">elif</span> <span class="n">cfg</span><span class="o">.</span><span class="n">geometry</span> <span class="o">==</span> <span class="s1">&#39;9M&#39;</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span> <span class="s1">&#39;Geometry == &#39;</span><span class="p">,</span> <span class="n">cfg</span><span class="o">.</span><span class="n">geometry</span> <span class="p">)</span>
        <span class="n">lines</span> <span class="o">=</span> <span class="p">[]</span>
        
        <span class="c1">#Module stuff</span>
        <span class="n">vcmp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">mask</span><span class="o">.</span><span class="n">eiger9M</span><span class="o">.</span><span class="n">module</span><span class="p">),</span> <span class="mi">8</span><span class="p">)</span> <span class="p">)</span>
        <span class="n">vcp</span>  <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">mask</span><span class="o">.</span><span class="n">eiger9M</span><span class="o">.</span><span class="n">module</span><span class="p">),</span> <span class="mi">2</span><span class="p">)</span> <span class="p">)</span>
        
        <span class="k">for</span> <span class="n">j</span><span class="p">,</span><span class="n">mod</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span> <span class="n">mask</span><span class="o">.</span><span class="n">eiger9M</span><span class="o">.</span><span class="n">module</span> <span class="p">):</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span> <span class="mi">8</span> <span class="p">):</span>
                <span class="n">m</span> <span class="o">=</span> <span class="n">fit_result</span><span class="p">[</span><span class="s1">&#39;mu&#39;</span><span class="p">][</span><span class="n">mod</span><span class="p">][</span><span class="n">mask</span><span class="o">.</span><span class="n">chip</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">th</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span> <span class="n">m</span><span class="p">[(</span><span class="n">m</span><span class="o">&gt;</span><span class="mi">10</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">m</span><span class="o">&lt;</span><span class="mi">1990</span><span class="p">)]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span> <span class="p">)</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="n">th</span> <span class="o">=</span> <span class="mi">0</span>

                <span class="n">vcmp</span><span class="p">[</span><span class="n">j</span><span class="p">,</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">th</span>
                
                <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">detector</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">type</span><span class="p">(</span> <span class="kc">None</span> <span class="p">):</span>
                    <span class="n">detector</span><span class="o">.</span><span class="n">set_dac</span><span class="p">(</span><span class="n">mask</span><span class="o">.</span><span class="n">eiger9M</span><span class="o">.</span><span class="n">vcmp</span><span class="p">[</span><span class="n">j</span><span class="o">*</span><span class="mi">8</span><span class="o">+</span><span class="n">i</span><span class="p">],</span> <span class="n">th</span><span class="p">)</span>
  
                <span class="c1">#Integer division!</span>
                <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;./sls_detector_put </span><span class="si">{:s}</span><span class="s1"> </span><span class="si">{:d}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span> <span class="n">mask</span><span class="o">.</span><span class="n">eiger9M</span><span class="o">.</span><span class="n">vcmp</span><span class="p">[</span><span class="n">j</span><span class="o">*</span><span class="mi">8</span><span class="o">+</span><span class="n">i</span><span class="p">],</span> <span class="n">th</span><span class="p">)</span> <span class="p">)</span>
                    
                <span class="n">mean</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">th</span>
        
            <span class="n">vcp0</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span> <span class="n">mean</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">4</span><span class="p">][</span><span class="n">mean</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">4</span><span class="p">]</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span> <span class="p">)</span>
            <span class="n">vcp1</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span> <span class="n">mean</span><span class="p">[</span><span class="mi">4</span><span class="p">:][</span><span class="n">mean</span><span class="p">[</span><span class="mi">4</span><span class="p">:]</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span> <span class="p">)</span>
            <span class="n">vcp</span><span class="p">[</span><span class="n">j</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">vcp0</span>
            <span class="n">vcp</span><span class="p">[</span><span class="n">j</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">vcp1</span>
            
            <span class="k">if</span> <span class="nb">type</span><span class="p">(</span> <span class="n">detector</span> <span class="p">)</span> <span class="o">!=</span> <span class="nb">type</span><span class="p">(</span><span class="kc">None</span><span class="p">):</span>
                <span class="n">detector</span><span class="o">.</span><span class="n">set_dac</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{:d}</span><span class="s1">:vcp&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">j</span><span class="o">*</span><span class="mi">2</span><span class="p">),</span> <span class="n">vcp0</span><span class="p">)</span>
                <span class="n">detector</span><span class="o">.</span><span class="n">set_dac</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{:d}</span><span class="s1">:vcp&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">j</span><span class="o">*</span><span class="mi">2</span><span class="o">+</span><span class="mi">1</span><span class="p">),</span> <span class="n">vcp1</span><span class="p">)</span> 
            
            <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;./sls_detector_put </span><span class="si">{:d}</span><span class="s1">:vcp </span><span class="si">{:d}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">j</span><span class="o">*</span><span class="mi">2</span><span class="p">,</span> <span class="n">vcp0</span><span class="p">))</span>
            <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;./sls_detector_put </span><span class="si">{:d}</span><span class="s1">:vcp </span><span class="si">{:d}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">j</span><span class="o">*</span><span class="mi">2</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">vcp1</span><span class="p">))</span>
                
        <span class="k">return</span> <span class="n">vcmp</span><span class="p">,</span> <span class="n">vcp</span><span class="p">,</span> <span class="n">lines</span></div>


<div class="viewcode-block" id="find_initial_parameters"><a class="viewcode-back" href="../../sls_detector_tools.html#sls_detector_tools.calibration.find_initial_parameters">[docs]</a><span class="k">def</span> <span class="nf">find_initial_parameters</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">,</span> <span class="n">thrange</span> <span class="o">=</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">2200</span><span class="p">)):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Tries to find the best initial parameters for an per pixel scurve fit</span>
<span class="sd">    by using the global average of a chip or module. </span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    x: numpy_array</span>
<span class="sd">        x values</span>
<span class="sd">    y: numpy_array </span>
<span class="sd">        y values</span>
<span class="sd">    thrange: (low, high)</span>
<span class="sd">        low and high edge for the fitting</span>
<span class="sd">        </span>
<span class="sd">    Returns</span>
<span class="sd">    --------</span>
<span class="sd">    par: numpy_array</span>
<span class="sd">        Array with the initial parameters of the fit</span>
<span class="sd">        </span>
<span class="sd">    .. todo::</span>
<span class="sd">        Remove hardcoded values where possible and be more flexible </span>
<span class="sd">        with the range</span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="n">func</span> <span class="o">=</span> <span class="n">TF1</span><span class="p">(</span><span class="s1">&#39;func&#39;</span><span class="p">,</span> <span class="n">function</span><span class="o">.</span><span class="n">root</span><span class="o">.</span><span class="n">scurve</span><span class="p">,</span> <span class="n">thrange</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">thrange</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
    <span class="k">if</span> <span class="n">cfg</span><span class="o">.</span><span class="n">calibration</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="s1">&#39;XRF&#39;</span><span class="p">:</span>
        
        <span class="n">func</span><span class="o">.</span><span class="n">SetParLimits</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span><span class="n">y</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="mi">5</span><span class="p">)</span>
        <span class="n">func</span><span class="o">.</span><span class="n">SetParLimits</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="n">thrange</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">thrange</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">func</span><span class="o">.</span><span class="n">SetParLimits</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">500</span><span class="p">)</span>
        <span class="n">func</span><span class="o">.</span><span class="n">SetParLimits</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">y</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">func</span><span class="o">.</span><span class="n">SetParameter</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">ipar</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">y</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="mi">0</span><span class="p">,</span><span class="mi">1200</span><span class="p">,</span><span class="mi">200</span><span class="p">,</span><span class="mi">1500</span><span class="p">,</span><span class="mi">1</span><span class="p">],</span> <span class="n">dtype</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">double</span><span class="p">)</span>
   
    <span class="k">elif</span> <span class="n">cfg</span><span class="o">.</span><span class="n">calibration</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="s1">&#39;TP&#39;</span><span class="p">:</span>
        <span class="c1">#Assumes 1000 pulses</span>
        <span class="n">func</span><span class="o">.</span><span class="n">FixParameter</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">func</span><span class="o">.</span><span class="n">FixParameter</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">func</span><span class="o">.</span><span class="n">FixParameter</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span><span class="mi">1000</span><span class="p">)</span>
        <span class="n">func</span><span class="o">.</span><span class="n">FixParameter</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">ipar</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">200</span><span class="p">,</span><span class="mi">200</span><span class="p">,</span><span class="mi">1000</span><span class="p">,</span><span class="mi">0</span><span class="p">],</span> <span class="n">dtype</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">double</span><span class="p">)</span>
        
    <span class="k">elif</span> <span class="n">cfg</span><span class="o">.</span><span class="n">calibration</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="s1">&#39;beam&#39;</span><span class="p">:</span>
        <span class="k">raise</span> <span class="bp">NotImplemented</span><span class="p">(</span><span class="s2">&quot;type == beam currently not implemented&quot;</span><span class="p">)</span>
    
    <span class="c1">#Set par and fit</span>
    <span class="n">func</span><span class="o">.</span><span class="n">SetParameters</span><span class="p">(</span><span class="n">ipar</span><span class="p">)</span>
    <span class="n">c</span><span class="p">,</span><span class="n">h</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">draw</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span>
    <span class="n">fit</span> <span class="o">=</span> <span class="n">h</span><span class="o">.</span><span class="n">Fit</span><span class="p">(</span><span class="s1">&#39;func&#39;</span><span class="p">,</span> <span class="s1">&#39;NRSQ&#39;</span><span class="p">)</span>        
    <span class="n">par</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span> <span class="p">[</span><span class="n">fit</span><span class="o">.</span><span class="n">Get</span><span class="p">()</span><span class="o">.</span><span class="n">Parameter</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">6</span><span class="p">)]</span> <span class="p">)</span>
    <span class="k">return</span> <span class="n">par</span></div>


    
<div class="viewcode-block" id="do_scurve"><a class="viewcode-back" href="../../sls_detector_tools.html#sls_detector_tools.calibration.do_scurve">[docs]</a><span class="k">def</span> <span class="nf">do_scurve</span><span class="p">(</span><span class="n">detector</span><span class="p">,</span> <span class="n">xraybox</span><span class="p">,</span> <span class="n">step</span> <span class="o">=</span> <span class="mi">40</span><span class="p">,</span> <span class="n">mask</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">thrange</span> <span class="o">=</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">2000</span><span class="p">)):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Take scurve data for calibration. When not using the Xray box pass a </span>
<span class="sd">    dummy xray box to the function and make sure that shutter is open and </span>
<span class="sd">    target is correct!</span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="n">base</span> <span class="o">=</span> <span class="n">cfg</span><span class="o">.</span><span class="n">det_id</span> <span class="o">+</span> <span class="s1">&#39;_vcmp_&#39;</span>
    
    <span class="n">xraybox</span><span class="o">.</span><span class="n">target</span><span class="p">(</span> <span class="n">cfg</span><span class="o">.</span><span class="n">calibration</span><span class="o">.</span><span class="n">target</span> <span class="p">)</span> 
    <span class="n">xraybox</span><span class="o">.</span><span class="n">shutter</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span> 
    
    <span class="n">detector</span><span class="o">.</span><span class="n">scan_dac</span><span class="p">(</span><span class="n">thrange</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">thrange</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">step</span><span class="p">,</span>
               <span class="n">dac</span> <span class="o">=</span> <span class="s1">&#39;vthreshold&#39;</span><span class="p">,</span>
               <span class="n">fname</span> <span class="o">=</span> <span class="n">base</span> <span class="o">+</span> <span class="n">cfg</span><span class="o">.</span><span class="n">calibration</span><span class="o">.</span><span class="n">target</span> <span class="o">+</span> <span class="s1">&#39;XRF&#39;</span><span class="p">,</span>
               <span class="n">run_id</span> <span class="o">=</span> <span class="n">cfg</span><span class="o">.</span><span class="n">calibration</span><span class="o">.</span><span class="n">run_id</span><span class="p">,</span>
               <span class="n">exptime</span> <span class="o">=</span> <span class="n">cfg</span><span class="o">.</span><span class="n">calibration</span><span class="o">.</span><span class="n">exptime</span><span class="p">,</span>
               <span class="n">vcp</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
               <span class="n">npz</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
               <span class="n">plot</span> <span class="o">=</span> <span class="n">cfg</span><span class="o">.</span><span class="n">calibration</span><span class="o">.</span><span class="n">plot</span><span class="p">)</span>
               
    <span class="n">xraybox</span><span class="o">.</span><span class="n">shutter</span><span class="p">(</span> <span class="kc">False</span> <span class="p">)</span>
    
    <span class="c1">#Load data and plot some pixel data</span>
    <span class="k">with</span> <span class="n">np</span><span class="o">.</span><span class="n">load</span><span class="p">(</span> <span class="n">cfg</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">data</span> <span class="o">+</span><span class="s1">&#39;/&#39;</span><span class="o">+</span> <span class="n">base</span> <span class="o">+</span><span class="n">cfg</span><span class="o">.</span><span class="n">calibration</span><span class="o">.</span><span class="n">target</span> <span class="o">+</span> <span class="s1">&#39;XRF&#39;</span><span class="o">+</span><span class="s1">&#39;_&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">cfg</span><span class="o">.</span><span class="n">calibration</span><span class="o">.</span><span class="n">run_id</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;.npz&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">f</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">]</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">f</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">]</span>          

    <span class="c1">#plotting the result of the scurve scan</span>
    <span class="k">if</span> <span class="n">cfg</span><span class="o">.</span><span class="n">calibration</span><span class="o">.</span><span class="n">plot</span><span class="p">:</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">u</span><span class="o">.</span><span class="n">random_pixel</span><span class="p">(</span><span class="n">N</span> <span class="o">=</span> <span class="mi">50</span><span class="p">,</span> <span class="n">rows</span> <span class="o">=</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],),</span> <span class="n">cols</span> <span class="o">=</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])):</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">data</span><span class="p">[</span><span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">p</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="p">:])</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span> <span class="n">cfg</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">get_data_fname</span><span class="p">()</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s1">&#39;.npz&#39;</span><span class="p">)</span> <span class="p">)</span> <span class="p">)</span>
   
    <span class="c1">#if data should be used interactivly</span>
    <span class="k">return</span> <span class="n">data</span><span class="p">,</span> <span class="n">x</span></div>
    
<div class="viewcode-block" id="do_scurve_fit"><a class="viewcode-back" href="../../sls_detector_tools.html#sls_detector_tools.calibration.do_scurve_fit">[docs]</a><span class="k">def</span> <span class="nf">do_scurve_fit</span><span class="p">(</span>  <span class="n">mask</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">fname</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">thrange</span> <span class="o">=</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">2000</span><span class="p">)</span> <span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Per pixel scurve fit from saved data and save the result in an npy file</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1">#Load the scurve data</span>
    <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">fname</span><span class="p">)</span> <span class="o">==</span> <span class="nb">type</span><span class="p">(</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">fname</span> <span class="o">=</span> <span class="n">get_data_fname</span><span class="p">()</span>
                

    <span class="n">pathname</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span> <span class="n">cfg</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">fname</span><span class="p">)</span>
    <span class="k">with</span> <span class="n">np</span><span class="o">.</span><span class="n">load</span><span class="p">(</span> <span class="n">pathname</span> <span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">f</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">]</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">f</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">]</span>
    
    <span class="c1">#if a mask was supplied take out the masked pixels</span>
    <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">mask</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">type</span><span class="p">(</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span> <span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="p">):</span>
            <span class="n">data</span><span class="p">[:,:,</span><span class="n">i</span><span class="p">][</span><span class="n">mask</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
     

    
    <span class="c1">#Normalize y then find initial prameters and fit</span>
    <span class="c1">#Should thir be rewritten?</span>
    
    <span class="n">y</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span> <span class="o">=</span> <span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span> <span class="o">=</span> <span class="mi">0</span><span class="p">)</span>
    <span class="n">y</span> <span class="o">=</span> <span class="n">y</span> <span class="o">/</span> <span class="p">(</span> <span class="n">data</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span> <span class="o">=</span> <span class="mi">2</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">0</span> <span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
    <span class="n">par</span> <span class="o">=</span> <span class="n">find_initial_parameters</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">)</span>

    <span class="n">fit_result</span> <span class="o">=</span> <span class="n">mpfit</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">cfg</span><span class="o">.</span><span class="n">calibration</span><span class="o">.</span><span class="n">nproc</span><span class="p">,</span> <span class="n">par</span><span class="p">)</span>  
    
    <span class="c1">#If specified plot and save the result</span>
    <span class="k">if</span> <span class="n">cfg</span><span class="o">.</span><span class="n">calibration</span><span class="o">.</span><span class="n">plot</span><span class="p">:</span>
        <span class="n">mean</span><span class="p">,</span> <span class="n">std</span><span class="p">,</span> <span class="n">lines</span> <span class="o">=</span> <span class="n">plot</span><span class="o">.</span><span class="n">chip_histograms</span><span class="p">(</span> <span class="n">fit_result</span><span class="p">[</span><span class="s1">&#39;mu&#39;</span><span class="p">],</span> <span class="n">xmin</span> <span class="o">=</span> <span class="n">thrange</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">xmax</span> <span class="o">=</span> <span class="n">thrange</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="p">)</span> 
        <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Vcmp [DAC LSB]&#39;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Number of Pixels&#39;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span> <span class="n">cfg</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">get_fit_fname</span><span class="p">()</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s1">&#39;.npy&#39;</span><span class="p">)</span> <span class="p">)</span> <span class="p">)</span>
    
    
    <span class="c1">#Save the fit result</span>
    <span class="n">fname</span> <span class="o">=</span> <span class="n">get_fit_fname</span><span class="p">()</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s1">&#39;.npy&#39;</span><span class="p">)</span>
    <span class="n">pathname</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">cfg</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">fname</span><span class="p">)</span>
    <span class="n">np</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">pathname</span><span class="p">,</span> <span class="n">fit_result</span><span class="p">)</span>
    
    <span class="k">return</span> <span class="n">fit_result</span></div>

<div class="viewcode-block" id="do_scurve_fit_scaled"><a class="viewcode-back" href="../../sls_detector_tools.html#sls_detector_tools.calibration.do_scurve_fit_scaled">[docs]</a><span class="k">def</span> <span class="nf">do_scurve_fit_scaled</span><span class="p">(</span>  <span class="n">mask</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">fname</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">thrange</span> <span class="o">=</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">2000</span><span class="p">)</span> <span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Per pixel scurve fit from saved data and save the result in an npy file</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1">#Load the scurve data</span>
    <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">fname</span><span class="p">)</span> <span class="o">==</span> <span class="nb">type</span><span class="p">(</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">fname</span> <span class="o">=</span> <span class="n">get_data_fname</span><span class="p">()</span>
                

    <span class="n">pathname</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span> <span class="n">cfg</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">fname</span><span class="p">)</span>
    <span class="k">with</span> <span class="n">np</span><span class="o">.</span><span class="n">load</span><span class="p">(</span> <span class="n">pathname</span> <span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">f</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">]</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">f</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">]</span>
    
    <span class="c1">#if a mask was supplied take out the masked pixels</span>
    <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">mask</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">type</span><span class="p">(</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span> <span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="p">):</span>
            <span class="n">data</span><span class="p">[:,:,</span><span class="n">i</span><span class="p">][</span><span class="n">mask</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
     
    <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">double</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">]):</span>
        <span class="n">data</span><span class="p">[:,:,</span><span class="n">i</span><span class="p">]</span> <span class="o">/=</span> <span class="n">data</span><span class="p">[:,:,</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">data</span> <span class="o">*=</span> <span class="mi">1000</span>
    
    <span class="c1">#Normalize y then find initial prameters and fit</span>
<span class="c1">#    y = data.sum(axis = 0).sum(axis = 0)</span>
<span class="c1">#    y /=  ( data.sum(axis = 2)&gt;0 ).sum()</span>
<span class="c1">#    par = find_initial_parameters(x,y)</span>
    <span class="n">par</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span> <span class="mi">0</span><span class="p">,</span>   <span class="mi">0</span><span class="p">,</span>   <span class="mf">1.11495212e+03</span><span class="p">,</span>
         <span class="mf">1.98609468e+02</span><span class="p">,</span>   <span class="mf">5.94207866e+02</span><span class="p">,</span>   <span class="mf">4.47860380e-01</span><span class="p">])</span>

    <span class="n">fit_result</span> <span class="o">=</span> <span class="n">mpfit</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">cfg</span><span class="o">.</span><span class="n">calibration</span><span class="o">.</span><span class="n">nproc</span><span class="p">,</span> <span class="n">par</span><span class="p">)</span>  
    
<span class="c1">#    #If specified plot and save the result</span>
<span class="c1">#    if cfg.calibration.plot:</span>
<span class="c1">#        mean, std, lines = plot.chip_histograms( fit_result[&#39;mu&#39;], xmin = thrange[0], xmax = thrange[1] ) </span>
<span class="c1">#        plt.xlabel(&#39;Vcmp [DAC LSB]&#39;)</span>
<span class="c1">#        plt.ylabel(&#39;Number of Pixels&#39;)</span>
<span class="c1">#        plt.savefig( os.path.join( cfg.path.data, get_fit_fname().strip(&#39;.npy&#39;) ) )</span>
<span class="c1">#    </span>
<span class="c1">#    </span>
<span class="c1">#    #Save the fit result</span>
<span class="c1">#    fname = get_fit_fname().strip(&#39;.npy&#39;)</span>
<span class="c1">#    pathname = os.path.join(cfg.path.data, fname)</span>
<span class="c1">#    np.save(pathname, fit_result)</span>
    
    <span class="k">return</span> <span class="n">fit_result</span></div>


<span class="k">def</span> <span class="nf">_take_trimbit_data</span><span class="p">(</span><span class="n">detector</span><span class="p">,</span> <span class="n">xraybox</span><span class="p">,</span> <span class="n">step</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span> <span class="n">data_mask</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Internal function to scan the trimbits and save the data</span>
<span class="sd">    can also be used when the detector is not directly controlled</span>
<span class="sd">    from the machine processing the data as in the case with the 9M</span>
<span class="sd">    &quot;&quot;&quot;</span>

           
    <span class="n">xraybox</span><span class="o">.</span><span class="n">target</span><span class="p">(</span> <span class="n">cfg</span><span class="o">.</span><span class="n">calibration</span><span class="o">.</span><span class="n">target</span> <span class="p">)</span>
    <span class="n">xraybox</span><span class="o">.</span><span class="n">shutter</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
    
    <span class="n">fname</span> <span class="o">=</span> <span class="n">get_tbdata_fname</span><span class="p">()</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s1">&#39;_</span><span class="si">{:d}</span><span class="s1">.npz&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">cfg</span><span class="o">.</span><span class="n">calibration</span><span class="o">.</span><span class="n">run_id</span><span class="p">))</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">detector</span><span class="o">.</span><span class="n">trimbit_scan</span><span class="p">(</span>
                   <span class="n">fname</span> <span class="o">=</span> <span class="n">fname</span><span class="p">,</span>
                   <span class="n">exptime</span> <span class="o">=</span> <span class="n">cfg</span><span class="o">.</span><span class="n">calibration</span><span class="o">.</span><span class="n">exptime</span><span class="p">,</span>
                   <span class="n">plot</span> <span class="o">=</span> <span class="n">cfg</span><span class="o">.</span><span class="n">calibration</span><span class="o">.</span><span class="n">plot</span><span class="p">,</span>
                   <span class="n">npz</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
                   <span class="n">step</span> <span class="o">=</span> <span class="n">step</span><span class="p">,</span>
                   <span class="n">run_id</span> <span class="o">=</span> <span class="n">cfg</span><span class="o">.</span><span class="n">calibration</span><span class="o">.</span><span class="n">run_id</span><span class="p">,</span> 
                   <span class="n">data_mask</span> <span class="o">=</span> <span class="n">data_mask</span><span class="p">)</span>
                   
    <span class="n">xraybox</span><span class="o">.</span><span class="n">shutter</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
    
    <span class="k">if</span> <span class="n">cfg</span><span class="o">.</span><span class="n">calibration</span><span class="o">.</span><span class="n">plot</span><span class="p">:</span>
        <span class="n">pathname</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span> <span class="n">cfg</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> 
                                 <span class="n">get_tbdata_fname</span><span class="p">()</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s1">&#39;.npz&#39;</span><span class="p">)</span> <span class="p">)</span> 
        <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span> <span class="n">pathname</span> <span class="p">)</span>    
    
<div class="viewcode-block" id="do_trimbit_scan"><a class="viewcode-back" href="../../sls_detector_tools.html#sls_detector_tools.calibration.do_trimbit_scan">[docs]</a><span class="k">def</span> <span class="nf">do_trimbit_scan</span><span class="p">(</span><span class="n">detector</span><span class="p">,</span> <span class="n">xraybox</span><span class="p">,</span> <span class="n">step</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span> <span class="n">data_mask</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Fuction to setup the detector with correct Vcmp and Vcp and then</span>
<span class="sd">    performa a trimbit scan </span>
<span class="sd">    </span>
<span class="sd">    </span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1">#Load data</span>
    <span class="n">data_fname</span> <span class="o">=</span> <span class="n">get_data_fname</span><span class="p">()</span>
    <span class="n">data_pathname</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span> <span class="n">cfg</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">data_fname</span><span class="p">)</span>
    <span class="k">with</span> <span class="n">np</span><span class="o">.</span><span class="n">load</span><span class="p">(</span> <span class="n">data_pathname</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">f</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">]</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">f</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">]</span>
        
    <span class="c1">#Load scurve fit</span>
    <span class="n">fit_fname</span> <span class="o">=</span> <span class="n">get_fit_fname</span><span class="p">()</span>
    <span class="n">fit_pathname</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span> <span class="n">cfg</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">fit_fname</span><span class="p">)</span>
    <span class="n">fit_result</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">load</span><span class="p">(</span> <span class="n">fit_pathname</span> <span class="p">)</span>
    
    
    <span class="c1">#Find the mean values for both module and half module</span>
    <span class="n">find_mean_and_set_vcmp</span><span class="p">(</span><span class="n">detector</span><span class="p">,</span> <span class="n">fit_result</span><span class="p">)</span>
           
    <span class="n">_take_trimbit_data</span><span class="p">(</span><span class="n">detector</span><span class="p">,</span> <span class="n">xraybox</span><span class="p">,</span> <span class="n">step</span> <span class="o">=</span> <span class="n">step</span><span class="p">,</span> <span class="n">data_mask</span> <span class="o">=</span> <span class="n">data_mask</span><span class="p">)</span></div>
    
    
<span class="c1">#    xraybox.target( cfg.calibration.target )</span>
<span class="c1">#    xraybox.shutter(True)</span>
<span class="c1">#    </span>
<span class="c1">#    fname = get_tbdata_fname().strip(&#39;_{:d}.npz&#39;.format(cfg.calibration.run_id))</span>
<span class="c1">#    data = detector.trimbit_scan(</span>
<span class="c1">#                   fname = fname,</span>
<span class="c1">#                   exptime = cfg.calibration.exptime,</span>
<span class="c1">#                   plot = True,</span>
<span class="c1">#                   npz = True,</span>
<span class="c1">#                   step = step,</span>
<span class="c1">#                   run_id = cfg.calibration.run_id, </span>
<span class="c1">#                   data_mask = data_mask)</span>
<span class="c1">#                   </span>
<span class="c1">#    xraybox.shutter(False)</span>

 

<div class="viewcode-block" id="load_trim"><a class="viewcode-back" href="../../sls_detector_tools.html#sls_detector_tools.calibration.load_trim">[docs]</a><span class="k">def</span> <span class="nf">load_trim</span><span class="p">(</span> <span class="n">detector</span> <span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Load trimbits for the current calibration settings. Defined in </span>
<span class="sd">    config.py </span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">fname</span> <span class="o">=</span> <span class="n">get_trimbit_fname</span><span class="p">()</span>
    <span class="n">pathname</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">cfg</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">fname</span><span class="p">)</span>
    <span class="n">detector</span><span class="o">.</span><span class="n">load_trim</span><span class="p">(</span><span class="n">pathname</span><span class="p">)</span></div>

<div class="viewcode-block" id="find_and_write_trimbits_scaled"><a class="viewcode-back" href="../../sls_detector_tools.html#sls_detector_tools.calibration.find_and_write_trimbits_scaled">[docs]</a><span class="k">def</span> <span class="nf">find_and_write_trimbits_scaled</span><span class="p">(</span><span class="n">fr_fname</span><span class="p">,</span> <span class="n">tb_fname</span><span class="p">,</span> <span class="n">scale</span> <span class="p">,</span> <span class="n">tau</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
    

    
    
    <span class="c1">#Load trimbit scan    </span>
    <span class="k">with</span> <span class="n">np</span><span class="o">.</span><span class="n">load</span><span class="p">(</span> <span class="n">tb_fname</span> <span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">f</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">]</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">f</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">]</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">64</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>    
    <span class="c1">#Scale data</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span> <span class="n">np</span><span class="o">.</span><span class="n">double</span> <span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">]):</span>
        <span class="n">data</span><span class="p">[:,:,</span><span class="n">i</span><span class="p">]</span> <span class="o">/=</span> <span class="n">scale</span>
    
    <span class="c1">#Load the fit result from the vcmp scan </span>
    <span class="n">fit_result</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">load</span><span class="p">(</span> <span class="n">fr_fname</span> <span class="p">)</span>
    
    <span class="c1">#Find the number of counts at the inflection point</span>
    <span class="n">target</span> <span class="o">=</span> <span class="n">function</span><span class="o">.</span><span class="n">scurve</span><span class="p">(</span> <span class="n">fit_result</span><span class="p">[</span><span class="s1">&#39;mu&#39;</span><span class="p">],</span> 
                <span class="n">fit_result</span><span class="p">[</span><span class="s1">&#39;p0&#39;</span><span class="p">],</span>
                <span class="n">fit_result</span><span class="p">[</span><span class="s1">&#39;p1&#39;</span><span class="p">],</span>
                <span class="n">fit_result</span><span class="p">[</span><span class="s1">&#39;mu&#39;</span><span class="p">],</span>
                <span class="n">fit_result</span><span class="p">[</span><span class="s1">&#39;sigma&#39;</span><span class="p">],</span> 
                <span class="n">fit_result</span><span class="p">[</span><span class="s1">&#39;A&#39;</span><span class="p">],</span>
                <span class="n">fit_result</span><span class="p">[</span><span class="s1">&#39;C&#39;</span><span class="p">])</span>
                

    <span class="n">par</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">9.35</span><span class="p">,</span> <span class="mf">2.08</span><span class="p">,</span> <span class="mf">33.5</span> <span class="p">,</span> <span class="mf">14.47</span><span class="p">,</span> <span class="mi">507</span><span class="p">,</span> <span class="mi">4</span><span class="p">])</span>
         
    <span class="n">result</span> <span class="o">=</span> <span class="n">mpfit</span><span class="o">.</span><span class="n">find_trimbits</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">target</span><span class="p">,</span> <span class="n">cfg</span><span class="o">.</span><span class="n">calibration</span><span class="o">.</span><span class="n">nproc</span><span class="p">,</span> <span class="n">par</span><span class="p">)</span> 
    <span class="n">tb</span> <span class="o">=</span> <span class="n">result</span><span class="p">[</span><span class="s1">&#39;trimbits&#39;</span><span class="p">]</span>
    <span class="n">tb</span><span class="p">[</span><span class="n">tb</span><span class="o">&gt;</span><span class="mi">63</span><span class="p">]</span> <span class="o">=</span> <span class="mi">63</span>
    <span class="n">tb</span><span class="p">[</span><span class="n">tb</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">tb</span> <span class="o">=</span> <span class="n">tb</span><span class="o">.</span><span class="n">round</span><span class="p">()</span>
    <span class="n">c</span><span class="p">,</span><span class="n">h</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">tb</span><span class="p">,</span> <span class="n">xmin</span> <span class="o">=</span> <span class="o">-.</span><span class="mi">5</span><span class="p">,</span> <span class="n">xmax</span> <span class="o">=</span> <span class="mf">63.5</span><span class="p">,</span> <span class="n">bins</span> <span class="o">=</span> <span class="mi">64</span><span class="p">)</span>
    <span class="n">tb</span> <span class="o">=</span> <span class="n">tb</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">)</span>
    <span class="n">ax</span><span class="p">,</span> <span class="n">im</span> <span class="o">=</span> <span class="n">plot</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">tb</span><span class="p">)</span>
<span class="c1">#    plt.savefig( os.path.join( cfg.path.data, get_tbdata_fname().strip(&#39;.npz&#39;) + &#39;_image&#39; ) )</span>
    
    <span class="k">return</span> <span class="n">tb</span><span class="p">,</span> <span class="n">target</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span><span class="n">x</span><span class="p">,</span> <span class="n">result</span></div>
    
<span class="c1">#    #Save trimbits in np file</span>
<span class="c1">#    </span>
<span class="c1">#    dacs = detector.dacs.get_asarray()</span>
<span class="c1">#</span>
<span class="c1">#    #Add tau for the new style trimbit files, to be default</span>
<span class="c1">#    if type(tau) != type(None):</span>
<span class="c1">#        tmp = np.zeros((dacs.shape[0], 1))</span>
<span class="c1">#        tmp[:] = tau</span>
<span class="c1">#        dacs = np.hstack( ( dacs, tmp) )</span>
<span class="c1">#        </span>
<span class="c1">#    fname = get_trimbit_fname()</span>
<span class="c1">#    pathname = os.path.join(cfg.path.data, fname)</span>
<span class="c1">#    </span>
<span class="c1">#</span>
<span class="c1">#    np.savez( pathname, trimbits = tb, fit = result)</span>
<span class="c1">#    </span>
<span class="c1">#    hostname = detector.get_hostname()</span>
<span class="c1">#    halfmodule = get_halfmodule_mask()</span>
<span class="c1">#</span>
<span class="c1">#        </span>
<span class="c1">#    for i in range( len(halfmodule) ):</span>
<span class="c1">#        fname = pathname + &#39;.sn&#39; + hostname[i][3:]</span>
<span class="c1">#        print(fname)</span>
<span class="c1">#        io.write_trimbit_file(fname, tb[halfmodule[i]], dacs[i]) </span>
    
<div class="viewcode-block" id="find_and_write_trimbits"><a class="viewcode-back" href="../../sls_detector_tools.html#sls_detector_tools.calibration.find_and_write_trimbits">[docs]</a><span class="k">def</span> <span class="nf">find_and_write_trimbits</span><span class="p">(</span><span class="n">detector</span><span class="p">,</span> <span class="n">tau</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
    
    <span class="c1">#Get the correct filenames depending on configuration settings</span>
    <span class="n">fit_fname</span> <span class="o">=</span> <span class="n">get_fit_fname</span><span class="p">()</span>
    <span class="n">data_fname</span> <span class="o">=</span> <span class="n">get_tbdata_fname</span><span class="p">()</span>
    <span class="n">data_pathname</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span> <span class="n">cfg</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">data_fname</span><span class="p">)</span>
    <span class="n">fit_pathname</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span> <span class="n">cfg</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">fit_fname</span><span class="p">)</span>
    
    <span class="c1">#Load trimbit scan    </span>
    <span class="k">with</span> <span class="n">np</span><span class="o">.</span><span class="n">load</span><span class="p">(</span> <span class="n">data_pathname</span> <span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">f</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">]</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">f</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">]</span>
    
    <span class="c1">#Load the fit result from the vcmp scan </span>
    <span class="n">fit_result</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">load</span><span class="p">(</span> <span class="n">fit_pathname</span> <span class="p">)</span>
    
    <span class="c1">#Find the number of counts at the inflection point</span>
    <span class="n">target</span> <span class="o">=</span> <span class="n">function</span><span class="o">.</span><span class="n">scurve</span><span class="p">(</span> <span class="n">fit_result</span><span class="p">[</span><span class="s1">&#39;mu&#39;</span><span class="p">],</span> 
                <span class="n">fit_result</span><span class="p">[</span><span class="s1">&#39;p0&#39;</span><span class="p">],</span>
                <span class="n">fit_result</span><span class="p">[</span><span class="s1">&#39;p1&#39;</span><span class="p">],</span>
                <span class="n">fit_result</span><span class="p">[</span><span class="s1">&#39;mu&#39;</span><span class="p">],</span>
                <span class="n">fit_result</span><span class="p">[</span><span class="s1">&#39;sigma&#39;</span><span class="p">],</span> 
                <span class="n">fit_result</span><span class="p">[</span><span class="s1">&#39;A&#39;</span><span class="p">],</span>
                <span class="n">fit_result</span><span class="p">[</span><span class="s1">&#39;C&#39;</span><span class="p">])</span>
                
    <span class="c1">#Magic numers for the initial parameters</span>
    <span class="c1">#TODO! Use a global fit for these</span>
<span class="c1">#    par = np.array([  8.65703068e+00,   1.46117014e+00,   20,</span>
<span class="c1">#         1.30881741e+01,   4.37825173e+03,   0.00000000e+00])</span>

    <span class="n">par</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span>  <span class="mi">60</span><span class="p">,</span>   <span class="mf">1.46117014e+00</span><span class="p">,</span>   <span class="mi">20</span><span class="p">,</span>
             <span class="mf">1.30881741e+01</span><span class="p">,</span>   <span class="mf">4.37825173e+03</span><span class="p">,</span>   <span class="mf">0.00000000e+00</span><span class="p">])</span>

         
    <span class="n">result</span> <span class="o">=</span> <span class="n">mpfit</span><span class="o">.</span><span class="n">find_trimbits</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">target</span><span class="p">,</span> <span class="n">cfg</span><span class="o">.</span><span class="n">calibration</span><span class="o">.</span><span class="n">nproc</span><span class="p">,</span> <span class="n">par</span><span class="p">)</span> 
    <span class="n">tb</span> <span class="o">=</span> <span class="n">result</span><span class="p">[</span><span class="s1">&#39;trimbits&#39;</span><span class="p">]</span>
    <span class="n">tb</span><span class="p">[</span><span class="n">tb</span><span class="o">&gt;</span><span class="mi">63</span><span class="p">]</span> <span class="o">=</span> <span class="mi">63</span>
    <span class="n">tb</span><span class="p">[</span><span class="n">tb</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">tb</span> <span class="o">=</span> <span class="n">tb</span><span class="o">.</span><span class="n">round</span><span class="p">()</span>
    <span class="n">c</span><span class="p">,</span><span class="n">h</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">tb</span><span class="p">,</span> <span class="n">xmin</span> <span class="o">=</span> <span class="o">-.</span><span class="mi">5</span><span class="p">,</span> <span class="n">xmax</span> <span class="o">=</span> <span class="mf">63.5</span><span class="p">,</span> <span class="n">bins</span> <span class="o">=</span> <span class="mi">64</span><span class="p">)</span>
    <span class="n">tb</span> <span class="o">=</span> <span class="n">tb</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">)</span>
    <span class="n">ax</span><span class="p">,</span> <span class="n">im</span> <span class="o">=</span> <span class="n">plot</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">tb</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span> <span class="n">cfg</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">get_tbdata_fname</span><span class="p">()</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s1">&#39;.npz&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;_image&#39;</span> <span class="p">)</span> <span class="p">)</span>
    
    
    <span class="c1">#Save trimbits in np file</span>
    
    <span class="n">dacs</span> <span class="o">=</span> <span class="n">detector</span><span class="o">.</span><span class="n">dacs</span><span class="o">.</span><span class="n">get_asarray</span><span class="p">()</span>

    <span class="c1">#Add tau for the new style trimbit files, to be default</span>
    <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">tau</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">type</span><span class="p">(</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">tmp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">dacs</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">1</span><span class="p">))</span>
        <span class="n">tmp</span><span class="p">[:]</span> <span class="o">=</span> <span class="n">tau</span>
        <span class="n">dacs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">(</span> <span class="p">(</span> <span class="n">dacs</span><span class="p">,</span> <span class="n">tmp</span><span class="p">)</span> <span class="p">)</span>
        
    <span class="n">fname</span> <span class="o">=</span> <span class="n">get_trimbit_fname</span><span class="p">()</span>
    <span class="n">pathname</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">cfg</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">fname</span><span class="p">)</span>
    

    <span class="n">np</span><span class="o">.</span><span class="n">savez</span><span class="p">(</span> <span class="n">pathname</span><span class="p">,</span> <span class="n">trimbits</span> <span class="o">=</span> <span class="n">tb</span><span class="p">,</span> <span class="n">fit</span> <span class="o">=</span> <span class="n">result</span><span class="p">)</span>
    
    <span class="n">hostname</span> <span class="o">=</span> <span class="n">detector</span><span class="o">.</span><span class="n">get_hostname</span><span class="p">()</span>
    <span class="n">halfmodule</span> <span class="o">=</span> <span class="n">get_halfmodule_mask</span><span class="p">()</span>

        
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span> <span class="nb">len</span><span class="p">(</span><span class="n">halfmodule</span><span class="p">)</span> <span class="p">):</span>
        <span class="n">fname</span> <span class="o">=</span> <span class="n">pathname</span> <span class="o">+</span> <span class="s1">&#39;.sn&#39;</span> <span class="o">+</span> <span class="n">hostname</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">3</span><span class="p">:]</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">fname</span><span class="p">)</span>
        <span class="n">io</span><span class="o">.</span><span class="n">write_trimbit_file</span><span class="p">(</span><span class="n">fname</span><span class="p">,</span> <span class="n">tb</span><span class="p">[</span><span class="n">halfmodule</span><span class="p">[</span><span class="n">i</span><span class="p">]],</span> <span class="n">dacs</span><span class="p">[</span><span class="n">i</span><span class="p">])</span></div>



<div class="viewcode-block" id="rewrite_calibration_files"><a class="viewcode-back" href="../../sls_detector_tools.html#sls_detector_tools.calibration.rewrite_calibration_files">[docs]</a><span class="k">def</span> <span class="nf">rewrite_calibration_files</span><span class="p">(</span><span class="n">detector</span><span class="p">,</span> <span class="n">tau</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">hostname</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Rewrite the calibration files using the center of the trimmed distributions</span>
<span class="sd">    saved with suffix _rw, needs a connected detector</span>
<span class="sd">    </span>
<span class="sd">    </span>
<span class="sd">    Specifying hostnames will use offline files only</span>
<span class="sd">    TODO! Tau should check if a tau is already present</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;det&#39;</span><span class="p">,</span> <span class="n">detector</span><span class="p">)</span>
    <span class="c1">#Load scurve fit</span>
    <span class="n">fit_fname</span> <span class="o">=</span> <span class="n">get_fit_fname</span><span class="p">()</span>
    <span class="n">fit_pathname</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span> <span class="n">cfg</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">fit_fname</span><span class="p">)</span>
    <span class="n">fit_result</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">load</span><span class="p">(</span> <span class="n">fit_pathname</span> <span class="p">)</span> 
 
    <span class="c1">#We have an detector online and should use it</span>
    <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">hostname</span><span class="p">)</span> <span class="o">==</span> <span class="nb">type</span><span class="p">(</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">find_mean_and_set_vcmp</span><span class="p">(</span><span class="n">detector</span><span class="p">,</span> <span class="n">fit_result</span><span class="p">)</span>
        <span class="n">hostname</span><span class="o">=</span> <span class="n">detector</span><span class="o">.</span><span class="n">get_hostname</span><span class="p">()</span>
        <span class="n">dacs</span> <span class="o">=</span> <span class="n">detector</span><span class="o">.</span><span class="n">dacs</span><span class="o">.</span><span class="n">get_asarray</span><span class="p">()</span>
        
    <span class="k">elif</span> <span class="nb">type</span><span class="p">(</span><span class="n">hostname</span><span class="p">)</span> <span class="o">==</span> <span class="nb">type</span><span class="p">(</span> <span class="p">[]</span> <span class="p">):</span>
        <span class="n">dacs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span> <span class="n">hostname</span> <span class="p">),</span> <span class="n">cfg</span><span class="o">.</span><span class="n">ndacs</span> <span class="o">+</span> <span class="mi">2</span> <span class="p">))</span>
        <span class="nb">print</span><span class="p">(</span> <span class="n">dacs</span><span class="o">.</span><span class="n">shape</span> <span class="p">)</span>
        <span class="n">vcmp</span><span class="p">,</span> <span class="n">vcp</span> <span class="o">=</span> <span class="n">find_mean_and_set_vcmp</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="n">fit_result</span><span class="p">)</span>
<span class="c1">#        return vcmp, vcp</span>
        <span class="n">dacobj</span> <span class="o">=</span> <span class="n">Dacs</span><span class="o">.</span><span class="n">Dacs</span><span class="p">(</span> <span class="kc">None</span> <span class="p">)</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s1">&#39;Type of hostname needs to be None for online or a list of hostnames for offline&#39;</span><span class="p">)</span>
        
    <span class="c1">#Adding tau, todo fix if tau is already there</span>
    <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">tau</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">type</span><span class="p">(</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">tmp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">dacs</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">1</span><span class="p">))</span>
        <span class="n">tmp</span><span class="p">[:]</span> <span class="o">=</span> <span class="n">tau</span>
        <span class="n">dacs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">(</span> <span class="p">(</span> <span class="n">dacs</span><span class="p">,</span> <span class="n">tmp</span><span class="p">)</span> <span class="p">)</span>

        
    <span class="c1">#Load trimbits </span>
    <span class="n">fname</span> <span class="o">=</span> <span class="n">get_trimbit_fname</span><span class="p">()</span>
    <span class="n">pathname</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">cfg</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">fname</span><span class="p">)</span>

    
    <span class="k">if</span> <span class="n">cfg</span><span class="o">.</span><span class="n">geometry</span> <span class="o">==</span> <span class="s1">&#39;2M&#39;</span><span class="p">:</span>
        <span class="c1">#ESRF 2M detector</span>
        <span class="n">halfmodule</span> <span class="o">=</span> <span class="n">mask</span><span class="o">.</span><span class="n">eiger2M</span><span class="o">.</span><span class="n">halfmodule</span>
        <span class="n">vcmp_name</span> <span class="o">=</span> <span class="n">mask</span><span class="o">.</span><span class="n">eiger2M</span><span class="o">.</span><span class="n">vcmp</span>
        
    <span class="k">elif</span> <span class="n">cfg</span><span class="o">.</span><span class="n">geometry</span> <span class="o">==</span> <span class="s1">&#39;500k&#39;</span><span class="p">:</span>
        <span class="n">halfmodule</span> <span class="o">=</span> <span class="n">mask</span><span class="o">.</span><span class="n">halfmodule</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s2">&quot;Add support for other modules&quot;</span><span class="p">)</span>
        
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span> <span class="nb">len</span><span class="p">(</span> <span class="n">halfmodule</span> <span class="p">)</span> <span class="p">):</span>
        <span class="n">fname</span> <span class="o">=</span> <span class="n">pathname</span> <span class="o">+</span> <span class="s1">&#39;.sn&#39;</span> <span class="o">+</span> <span class="n">hostname</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">3</span><span class="p">:]</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">fname</span><span class="p">)</span>
        <span class="n">tb</span><span class="p">,</span> <span class="n">tmpdacs</span> <span class="o">=</span> <span class="n">io</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">read_trimbit_file</span><span class="p">(</span> <span class="n">fname</span> <span class="p">)</span>
        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">detector</span><span class="p">)</span> <span class="o">==</span> <span class="nb">type</span><span class="p">(</span><span class="kc">None</span><span class="p">):</span>
            <span class="n">dacs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">tmpdacs</span>
            
            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span> <span class="n">cfg</span><span class="o">.</span><span class="n">nchips_per_halfmodule</span> <span class="p">):</span>
                <span class="n">idx</span> <span class="o">=</span><span class="n">i</span><span class="o">*</span><span class="n">cfg</span><span class="o">.</span><span class="n">nchips_per_halfmodule</span> <span class="o">+</span> <span class="n">j</span>
                <span class="n">vcmp_idx</span> <span class="o">=</span> <span class="n">dacobj</span><span class="o">.</span><span class="n">get_index</span><span class="p">(</span> <span class="n">vcmp_name</span><span class="p">[</span><span class="n">idx</span><span class="p">][</span><span class="mi">2</span><span class="p">:]</span> <span class="p">)</span>
                <span class="n">dacs</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">vcmp_idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">vcmp</span><span class="o">.</span><span class="n">flat</span><span class="p">[</span> <span class="n">i</span><span class="o">*</span><span class="n">cfg</span><span class="o">.</span><span class="n">nchips_per_halfmodule</span> <span class="o">+</span> <span class="n">j</span> <span class="p">]</span>
                
            <span class="n">vcp_idx</span> <span class="o">=</span> <span class="n">dacobj</span><span class="o">.</span><span class="n">get_index</span><span class="p">(</span><span class="s1">&#39;vcp&#39;</span><span class="p">)</span>
            <span class="n">dacs</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">vcp_idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">vcp</span><span class="o">.</span><span class="n">flat</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="nb">print</span><span class="p">(</span> <span class="n">tmpdacs</span><span class="p">[</span><span class="n">vcp_idx</span><span class="p">],</span> <span class="n">dacs</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">vcp_idx</span><span class="p">],</span> <span class="n">vcp</span><span class="o">.</span><span class="n">flat</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="p">)</span>
                
        
        <span class="c1">#Write with correct trimbits</span>
        <span class="n">fname</span> <span class="o">=</span> <span class="n">pathname</span> <span class="o">+</span> <span class="s1">&#39;_rw.sn&#39;</span> <span class="o">+</span> <span class="n">hostname</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">3</span><span class="p">:]</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">fname</span><span class="p">)</span></div>
<span class="c1">#        io.write_trimbit_file(fname, tb, dacs[i])</span>




<div class="viewcode-block" id="find_mean_and_std"><a class="viewcode-back" href="../../sls_detector_tools.html#sls_detector_tools.calibration.find_mean_and_std">[docs]</a><span class="k">def</span> <span class="nf">find_mean_and_std</span><span class="p">(</span> <span class="n">fit_result</span> <span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Find mean and standard deviation for each chip in the detector</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">mean</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">std</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">mask</span><span class="o">.</span><span class="n">detector</span><span class="p">[</span> <span class="n">cfg</span><span class="o">.</span><span class="n">geometry</span> <span class="p">]</span><span class="o">.</span><span class="n">module</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">mask</span><span class="o">.</span><span class="n">chip</span><span class="p">:</span>
            <span class="n">mean</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="n">fit_result</span><span class="p">[</span><span class="s1">&#39;mu&#39;</span><span class="p">][</span><span class="n">m</span><span class="p">][</span><span class="n">c</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span> <span class="p">)</span>
            <span class="n">std</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="n">fit_result</span><span class="p">[</span><span class="s1">&#39;mu&#39;</span><span class="p">][</span><span class="n">m</span><span class="p">][</span><span class="n">c</span><span class="p">]</span><span class="o">.</span><span class="n">std</span><span class="p">()</span> <span class="p">)</span>
            
    <span class="k">return</span> <span class="n">mean</span><span class="p">,</span> <span class="n">std</span></div>

<div class="viewcode-block" id="generate_mask"><a class="viewcode-back" href="../../sls_detector_tools.html#sls_detector_tools.calibration.generate_mask">[docs]</a><span class="k">def</span> <span class="nf">generate_mask</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Generate mask of bad pixels using calibration data</span>
<span class="sd">    TODO! verify with multi module systems</span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="c1">#Load data</span>
    <span class="n">fit_result</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">load</span><span class="p">(</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span> <span class="n">cfg</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">get_fit_fname</span><span class="p">())</span> <span class="p">)</span>
    <span class="n">mean</span><span class="p">,</span> <span class="n">std</span> <span class="o">=</span> <span class="n">find_mean_and_std</span><span class="p">(</span> <span class="n">fit_result</span> <span class="p">)</span>
    
    <span class="c1">#Mask</span>
    <span class="n">bad_pixels</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span> <span class="p">(</span><span class="n">mask</span><span class="o">.</span><span class="n">detector</span><span class="p">[</span> <span class="n">cfg</span><span class="o">.</span><span class="n">geometry</span> <span class="p">]</span><span class="o">.</span><span class="n">nrow</span><span class="p">,</span>
                            <span class="n">mask</span><span class="o">.</span><span class="n">detector</span><span class="p">[</span> <span class="n">cfg</span><span class="o">.</span><span class="n">geometry</span> <span class="p">]</span><span class="o">.</span><span class="n">ncol</span><span class="p">),</span>
                            <span class="n">dtype</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">bool</span><span class="p">)</span>
    
    <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">mask</span><span class="o">.</span><span class="n">detector</span><span class="p">[</span> <span class="n">cfg</span><span class="o">.</span><span class="n">geometry</span> <span class="p">]</span><span class="o">.</span><span class="n">module</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">mask</span><span class="o">.</span><span class="n">chip</span><span class="p">:</span>
            <span class="n">tmp</span> <span class="o">=</span> <span class="n">fit_result</span><span class="p">[</span><span class="s1">&#39;mu&#39;</span><span class="p">][</span><span class="n">m</span><span class="p">][</span><span class="n">c</span><span class="p">]</span>
            <span class="n">tmp</span><span class="o">=</span> <span class="p">(</span><span class="n">tmp</span> <span class="o">&lt;</span> <span class="n">mean</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-</span><span class="n">cfg</span><span class="o">.</span><span class="n">calibration</span><span class="o">.</span><span class="n">std</span><span class="o">*</span><span class="n">std</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="o">|</span> <span class="p">(</span><span class="n">tmp</span> <span class="o">&gt;</span> <span class="n">mean</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">+</span><span class="n">cfg</span><span class="o">.</span><span class="n">calibration</span><span class="o">.</span><span class="n">std</span><span class="o">*</span><span class="n">std</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> 
            <span class="n">bad_pixels</span><span class="p">[</span><span class="n">m</span><span class="p">][</span><span class="n">c</span><span class="p">][</span><span class="n">tmp</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="n">i</span><span class="o">+=</span> <span class="mi">1</span>
            
    <span class="nb">print</span><span class="p">(</span> <span class="s1">&#39;Masking </span><span class="si">{:d}</span><span class="s1"> pixels using </span><span class="si">{:d}</span><span class="s1"> std&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">bad_pixels</span><span class="o">.</span><span class="n">sum</span><span class="p">(),</span> <span class="n">cfg</span><span class="o">.</span><span class="n">calibration</span><span class="o">.</span><span class="n">std</span><span class="p">)</span> <span class="p">)</span>
    <span class="k">return</span> <span class="n">bad_pixels</span></div>

    
<div class="viewcode-block" id="take_global_calibration_data"><a class="viewcode-back" href="../../sls_detector_tools.html#sls_detector_tools.calibration.take_global_calibration_data">[docs]</a><span class="k">def</span> <span class="nf">take_global_calibration_data</span><span class="p">(</span><span class="n">detector</span><span class="p">,</span> <span class="n">xraybox</span><span class="p">,</span> <span class="n">thrange</span> <span class="o">=</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">2000</span><span class="p">)):</span>
    <span class="n">base</span> <span class="o">=</span> <span class="n">cfg</span><span class="o">.</span><span class="n">det_id</span> <span class="o">+</span> <span class="s1">&#39;_vcmp_&#39;</span>
    <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">cfg</span><span class="o">.</span><span class="n">calibration</span><span class="o">.</span><span class="n">global_targets</span><span class="p">[</span> <span class="n">cfg</span><span class="o">.</span><span class="n">calibration</span><span class="o">.</span><span class="n">target</span> <span class="p">]:</span>
        <span class="nb">print</span><span class="p">(</span> <span class="n">t</span> <span class="p">)</span>
        
        <span class="n">xraybox</span><span class="o">.</span><span class="n">target</span><span class="p">(</span> <span class="n">t</span> <span class="p">)</span> 
        <span class="n">xraybox</span><span class="o">.</span><span class="n">shutter</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">detector</span><span class="o">.</span><span class="n">scan_dac</span><span class="p">(</span><span class="n">thrange</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">thrange</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="mi">20</span><span class="p">,</span>
                   <span class="n">dac</span> <span class="o">=</span> <span class="s1">&#39;vthreshold&#39;</span><span class="p">,</span>
                   <span class="n">fname</span> <span class="o">=</span> <span class="n">base</span> <span class="o">+</span> <span class="n">t</span> <span class="o">+</span> <span class="s1">&#39;XRF&#39;</span><span class="p">,</span>
                   <span class="n">run_id</span> <span class="o">=</span> <span class="n">cfg</span><span class="o">.</span><span class="n">calibration</span><span class="o">.</span><span class="n">run_id</span><span class="p">,</span>
                   <span class="n">exptime</span> <span class="o">=</span> <span class="n">cfg</span><span class="o">.</span><span class="n">calibration</span><span class="o">.</span><span class="n">vrf_scan_exptime</span><span class="p">,</span>
                   <span class="n">vcp</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
                   <span class="n">npz</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
                   <span class="n">plot</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span>
         
        <span class="n">xraybox</span><span class="o">.</span><span class="n">shutter</span><span class="p">(</span> <span class="kc">False</span> <span class="p">)</span></div>
        
<div class="viewcode-block" id="per_chip_global_calibration"><a class="viewcode-back" href="../../sls_detector_tools.html#sls_detector_tools.calibration.per_chip_global_calibration">[docs]</a><span class="k">def</span> <span class="nf">per_chip_global_calibration</span><span class="p">(</span> <span class="n">swap_axes</span> <span class="o">=</span> <span class="kc">False</span> <span class="p">):</span>
    <span class="c1">#Find which calibration points we have</span>

    <span class="n">plotfit</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="n">target</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">energy</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span> <span class="n">cfg</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">data</span> <span class="p">):</span>
        <span class="k">if</span> <span class="n">f</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">cfg</span><span class="o">.</span><span class="n">det_id</span> <span class="o">+</span> <span class="s1">&#39;_vcmp_&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">f</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span> <span class="n">cfg</span><span class="o">.</span><span class="n">calibration</span><span class="o">.</span><span class="n">run_id</span> <span class="p">)</span><span class="o">+</span><span class="s1">&#39;.npz&#39;</span><span class="p">):</span>
            <span class="nb">print</span><span class="p">(</span> <span class="n">f</span> <span class="p">)</span>
            <span class="n">t</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)[</span><span class="mi">2</span><span class="p">][</span><span class="mi">0</span><span class="p">:</span><span class="mi">2</span><span class="p">]</span>
            <span class="n">target</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="n">t</span> <span class="p">)</span>
            <span class="n">energy</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="n">xrf</span><span class="p">[</span><span class="n">t</span><span class="p">]</span> <span class="p">)</span>
    
    <span class="n">xx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">2000</span><span class="p">)</span>
    
    <span class="n">mu</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">8</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">target</span><span class="p">)))</span>

    
    <span class="n">p0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">8</span><span class="p">)</span>
    <span class="n">p1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">8</span><span class="p">)</span>

    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    scruve function used for energy calibration</span>
<span class="sd">    scurve(x, p0,p1, mu, sigma, A, C)</span>
<span class="sd">    </span>
<span class="sd">    [0] - p0</span>
<span class="sd">    [1] - p1</span>
<span class="sd">    [2] - mu</span>
<span class="sd">    [3] - sigma</span>
<span class="sd">    [4] - A</span>
<span class="sd">    [5] - C</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="nb">print</span><span class="p">(</span> <span class="n">target</span> <span class="p">)</span>

    
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">t</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">target</span><span class="p">):</span>
        
        <span class="c1">#Custom limits</span>
        <span class="k">if</span> <span class="n">t</span> <span class="o">==</span> <span class="s1">&#39;Ag&#39;</span><span class="p">:</span>
            <span class="n">lim_high_fit</span> <span class="o">=</span> <span class="mi">1800</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">lim_high_fit</span> <span class="o">=</span> <span class="mi">2400</span>
            
        <span class="c1">#Load data</span>
        <span class="n">fname</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{:s}</span><span class="s1">_vcmp_</span><span class="si">{:s}</span><span class="s1">XRF_</span><span class="si">{:d}</span><span class="s1">.npz&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">cfg</span><span class="o">.</span><span class="n">det_id</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">cfg</span><span class="o">.</span><span class="n">calibration</span><span class="o">.</span><span class="n">run_id</span><span class="p">)</span>
        <span class="n">pathname</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span> <span class="n">cfg</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">fname</span> <span class="p">)</span>
        <span class="k">with</span> <span class="n">np</span><span class="o">.</span><span class="n">load</span><span class="p">(</span> <span class="n">pathname</span> <span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">f</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">]</span>
            <span class="n">x</span> <span class="o">=</span> <span class="n">f</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">]</span>
            
        <span class="k">if</span> <span class="n">swap_axes</span><span class="p">:</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">swapaxes</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span> <span class="p">)</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">swapaxes</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span> <span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span> <span class="n">data</span><span class="o">.</span><span class="n">shape</span> <span class="p">)</span>
            
        <span class="c1">#Clean up data</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span> <span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="p">):</span>
            <span class="n">m</span> <span class="o">=</span> <span class="n">data</span><span class="p">[:,:,</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">m</span> <span class="o">&lt;</span> <span class="n">cfg</span><span class="o">.</span><span class="n">calibration</span><span class="o">.</span><span class="n">clean_threshold</span><span class="p">:</span>
                <span class="n">m</span>  <span class="o">=</span> <span class="n">cfg</span><span class="o">.</span><span class="n">calibration</span><span class="o">.</span><span class="n">clean_threshold</span>
                
            <span class="n">data</span><span class="p">[:,:,</span><span class="n">k</span><span class="p">][</span><span class="n">data</span><span class="p">[:,:,</span><span class="n">k</span><span class="p">]</span><span class="o">&gt;</span> <span class="mi">3</span><span class="o">*</span> <span class="n">m</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>            
            
            
        <span class="c1">#Fit scurve for each chip and save mu parameter</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span> <span class="n">figsize</span> <span class="o">=</span> <span class="p">(</span><span class="mi">14</span><span class="p">,</span><span class="mi">7</span><span class="p">))</span>
        <span class="n">colors</span> <span class="o">=</span> <span class="n">sns</span><span class="o">.</span><span class="n">color_palette</span><span class="p">(</span><span class="n">n_colors</span> <span class="o">=</span> <span class="mi">8</span><span class="p">)</span>
        
        <span class="nb">print</span><span class="p">(</span> <span class="s1">&#39;target:&#39;</span><span class="p">,</span> <span class="n">t</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">8</span><span class="p">):</span>
            <span class="n">y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span> <span class="n">x</span><span class="o">.</span><span class="n">size</span> <span class="p">)</span>
            <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">size</span><span class="p">):</span>
                <span class="n">y</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[:,:,</span><span class="n">k</span><span class="p">][</span><span class="n">mask</span><span class="o">.</span><span class="n">chip</span><span class="p">[</span><span class="n">j</span><span class="p">]]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
            
            <span class="nb">print</span><span class="p">(</span> <span class="s2">&quot;[dbg] 1&quot;</span> <span class="p">)</span>
            <span class="c1">#Linear backgroud</span>
            <span class="n">g</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">t_graph</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="n">x</span><span class="o">&lt;</span><span class="mi">100</span><span class="p">],</span> <span class="n">y</span><span class="p">[</span><span class="n">x</span><span class="o">&lt;</span><span class="mi">100</span><span class="p">])</span> 
            <span class="n">fit</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">Fit</span><span class="p">(</span><span class="s1">&#39;pol1&#39;</span><span class="p">,</span> <span class="s1">&#39;NQS&#39;</span><span class="p">)</span>
            <span class="n">p0_estimate</span> <span class="o">=</span> <span class="n">fit</span><span class="o">.</span><span class="n">Get</span><span class="p">()</span><span class="o">.</span><span class="n">Parameter</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">p1_estimate</span> <span class="o">=</span> <span class="n">fit</span><span class="o">.</span><span class="n">Get</span><span class="p">()</span><span class="o">.</span><span class="n">Parameter</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
            
            <span class="c1">#Graph and fit function</span>
            <span class="n">c</span><span class="p">,</span><span class="n">h</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">)</span>
            <span class="n">func</span> <span class="o">=</span> <span class="n">TF1</span><span class="p">(</span><span class="s1">&#39;scurve&#39;</span><span class="p">,</span> <span class="n">function</span><span class="o">.</span><span class="n">root</span><span class="o">.</span><span class="n">scurve</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">lim_high_fit</span><span class="p">)</span>


            <span class="nb">print</span><span class="p">(</span> <span class="s2">&quot;[dbg] 2&quot;</span> <span class="p">)</span>
            
            <span class="c1">#Background from a linear fit in the 0-100 region</span>
            <span class="n">func</span><span class="o">.</span><span class="n">SetParameter</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">p0_estimate</span><span class="p">)</span> 
            <span class="n">func</span><span class="o">.</span><span class="n">SetParLimits</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">p0_estimate</span><span class="o">*.</span><span class="mi">5</span><span class="p">,</span> <span class="n">p0_estimate</span><span class="o">*</span><span class="mi">2</span><span class="p">)</span>
            <span class="n">func</span><span class="o">.</span><span class="n">SetParameter</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">p1_estimate</span><span class="p">)</span>
            <span class="n">func</span><span class="o">.</span><span class="n">SetParLimits</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">p1_estimate</span><span class="o">*</span><span class="mi">2</span><span class="p">)</span>
    
            <span class="c1">#mu must be in the range that we are using</span>
            <span class="n">func</span><span class="o">.</span><span class="n">SetParLimits</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">2500</span><span class="p">)</span>
            <span class="n">func</span><span class="o">.</span><span class="n">SetParameter</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1000</span> <span class="p">)</span> 
    
            <span class="c1">#Give this a reasonable value       </span>
            <span class="n">func</span><span class="o">.</span><span class="n">SetParameter</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">100</span><span class="p">)</span>
            <span class="n">func</span><span class="o">.</span><span class="n">SetParLimits</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">300</span><span class="p">)</span>         
    
            <span class="c1">#TODO! Find better estimates</span>
            <span class="n">func</span><span class="o">.</span><span class="n">SetParLimits</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mf">1e10</span><span class="p">)</span>
            <span class="n">func</span><span class="o">.</span><span class="n">SetParLimits</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mf">1e7</span><span class="p">)</span>
    
          
            <span class="n">fit</span> <span class="o">=</span> <span class="n">h</span><span class="o">.</span><span class="n">Fit</span><span class="p">(</span><span class="s1">&#39;scurve&#39;</span><span class="p">,</span> <span class="s1">&#39;SQR&#39;</span><span class="p">)</span>        
            <span class="n">fit</span> <span class="o">=</span> <span class="n">h</span><span class="o">.</span><span class="n">Fit</span><span class="p">(</span><span class="s1">&#39;scurve&#39;</span><span class="p">,</span> <span class="s1">&#39;SQR&#39;</span><span class="p">)</span>     

            <span class="n">par</span> <span class="o">=</span> <span class="p">[</span><span class="n">fit</span><span class="o">.</span><span class="n">Get</span><span class="p">()</span><span class="o">.</span><span class="n">Parameter</span><span class="p">(</span><span class="n">k</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">6</span><span class="p">)]</span>
            <span class="n">y_fit</span> <span class="o">=</span> <span class="n">function</span><span class="o">.</span><span class="n">scurve</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="o">*</span><span class="n">par</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">,</span> <span class="s1">&#39;o&#39;</span><span class="p">,</span> <span class="n">color</span> <span class="o">=</span> <span class="n">colors</span><span class="p">[</span><span class="n">j</span><span class="p">])</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y_fit</span><span class="p">,</span> <span class="n">color</span> <span class="o">=</span> <span class="n">colors</span><span class="p">[</span><span class="n">j</span><span class="p">])</span>
            
            <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">gradient</span><span class="p">(</span><span class="n">y</span><span class="p">),</span><span class="s1">&#39;o&#39;</span><span class="p">,</span> <span class="n">color</span> <span class="o">=</span> <span class="n">colors</span><span class="p">[</span><span class="n">j</span><span class="p">])</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">gradient</span><span class="p">(</span><span class="n">y_fit</span><span class="p">),</span> <span class="n">color</span> <span class="o">=</span> <span class="n">colors</span><span class="p">[</span><span class="n">j</span><span class="p">])</span>
            
            
            <span class="n">mu</span><span class="p">[</span><span class="n">j</span><span class="p">,</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">fit</span><span class="o">.</span><span class="n">Get</span><span class="p">()</span><span class="o">.</span><span class="n">Parameter</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>



    <span class="c1">#Fit linear calibration for each chip</span>
    <span class="n">colors</span> <span class="o">=</span><span class="n">sns</span><span class="o">.</span><span class="n">diverging_palette</span><span class="p">(</span><span class="mi">145</span><span class="p">,</span> <span class="mi">280</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">85</span><span class="p">,</span> <span class="n">l</span><span class="o">=</span><span class="mi">25</span><span class="p">,</span> <span class="n">n</span><span class="o">=</span><span class="mi">9</span><span class="p">)</span>
    <span class="n">colors</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span> <span class="c1">#Remove central gray</span>
    <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">8</span><span class="p">):</span>
        <span class="n">c</span><span class="p">,</span><span class="n">h</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">mu</span><span class="p">[</span><span class="n">j</span><span class="p">],</span> <span class="n">energy</span><span class="p">,</span> <span class="n">options</span> <span class="o">=</span> <span class="s1">&#39;AP&#39;</span><span class="p">)</span>
        <span class="n">fit</span> <span class="o">=</span> <span class="n">h</span><span class="o">.</span><span class="n">Fit</span><span class="p">(</span><span class="s1">&#39;pol1&#39;</span><span class="p">,</span> <span class="s1">&#39;SQ&#39;</span><span class="p">)</span>
        <span class="n">p0</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">fit</span><span class="o">.</span><span class="n">Get</span><span class="p">()</span><span class="o">.</span><span class="n">Parameter</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">p1</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">fit</span><span class="o">.</span><span class="n">Get</span><span class="p">()</span><span class="o">.</span><span class="n">Parameter</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    
        <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="s1">&#39;calibration&#39;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">mu</span><span class="p">[</span><span class="n">j</span><span class="p">],</span> <span class="n">energy</span><span class="p">,</span> <span class="s1">&#39;o&#39;</span><span class="p">,</span> <span class="n">color</span> <span class="o">=</span> <span class="n">colors</span><span class="p">[</span><span class="n">j</span><span class="p">],</span> <span class="n">label</span> <span class="o">=</span> <span class="s1">&#39;Chip: </span><span class="si">{:d}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">j</span><span class="p">))</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">xx</span><span class="p">,</span> <span class="n">function</span><span class="o">.</span><span class="n">pol1</span><span class="p">(</span><span class="n">xx</span><span class="p">,</span> <span class="n">p0</span><span class="p">[</span><span class="n">j</span><span class="p">],</span><span class="n">p1</span><span class="p">[</span><span class="n">j</span><span class="p">]),</span> <span class="n">color</span> <span class="o">=</span> <span class="n">colors</span><span class="p">[</span><span class="n">j</span><span class="p">])</span>
 
    <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>  
    <span class="n">e_low</span> <span class="o">=</span>  <span class="n">p0</span><span class="o">+</span><span class="n">p1</span><span class="o">*</span><span class="mi">1900</span> 
    <span class="n">e_high</span> <span class="o">=</span>  <span class="n">p0</span><span class="o">+</span><span class="n">p1</span><span class="o">*</span><span class="mi">100</span> 
        
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">8</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">e_low</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">e_high</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">e_low</span><span class="o">.</span><span class="n">max</span><span class="p">(),</span> <span class="n">e_high</span><span class="o">.</span><span class="n">min</span><span class="p">())</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">e_low</span><span class="o">.</span><span class="n">std</span><span class="p">(),</span> <span class="n">e_high</span><span class="o">.</span><span class="n">std</span><span class="p">())</span>
    <span class="n">calibration_fname</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span> <span class="n">cfg</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="s1">&#39;calibration&#39;</span> <span class="p">)</span>
    <span class="n">np</span><span class="o">.</span><span class="n">savez</span><span class="p">(</span><span class="n">calibration_fname</span><span class="p">,</span> <span class="n">p0</span> <span class="o">=</span> <span class="n">p0</span><span class="p">,</span> <span class="n">p1</span> <span class="o">=</span> <span class="n">p1</span><span class="p">,</span> <span class="n">mu</span> <span class="o">=</span> <span class="n">mu</span><span class="p">,</span> <span class="n">energy</span> <span class="o">=</span> <span class="n">energy</span><span class="p">)</span>
    
    <span class="k">return</span> <span class="n">p0</span><span class="p">,</span> <span class="n">p1</span></div>
    
<div class="viewcode-block" id="generate_calibration_report"><a class="viewcode-back" href="../../sls_detector_tools.html#sls_detector_tools.calibration.generate_calibration_report">[docs]</a><span class="k">def</span> <span class="nf">generate_calibration_report</span><span class="p">(</span> <span class="n">thrange</span> <span class="o">=</span> <span class="p">(</span><span class="mi">100</span><span class="p">,</span><span class="mi">1900</span><span class="p">)</span> <span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Generate a calibration report for the current gain. </span>
<span class="sd">    </span>
<span class="sd">    .. warning::</span>
<span class="sd">        Follows the old style of calibration and should be updated. Still</span>
<span class="sd">        gives a valuble insigt of the calibration for this gain though.</span>
<span class="sd">    </span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span> <span class="n">cfg</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>

    <span class="c1">#Load trimbit data</span>
    <span class="n">fname</span> <span class="o">=</span> <span class="n">get_trimbit_fname</span><span class="p">()</span>
    <span class="n">tb_top</span> <span class="o">=</span> <span class="n">io</span><span class="o">.</span><span class="n">read_trimbit_file</span><span class="p">(</span> <span class="n">fname</span> <span class="o">+</span> <span class="s1">&#39;.sn&#39;</span> <span class="o">+</span><span class="n">cfg</span><span class="o">.</span><span class="n">top</span><span class="p">[</span><span class="mi">3</span><span class="p">:]</span> <span class="p">)</span>    
    <span class="n">tb_bottom</span> <span class="o">=</span> <span class="n">io</span><span class="o">.</span><span class="n">read_trimbit_file</span><span class="p">(</span> <span class="n">fname</span> <span class="o">+</span> <span class="s1">&#39;.sn&#39;</span> <span class="o">+</span> <span class="n">cfg</span><span class="o">.</span><span class="n">bottom</span><span class="p">[</span><span class="mi">3</span><span class="p">:]</span> <span class="p">)</span>  
    <span class="n">vrf</span> <span class="o">=</span> <span class="p">[</span><span class="n">tb_top</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">2</span><span class="p">],</span> <span class="n">tb_bottom</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">2</span><span class="p">]]</span>
    
    <span class="c1">#Create output file</span>
    <span class="n">fname</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{:s}</span><span class="s1">_</span><span class="si">{:s}</span><span class="s1">_calibration_report.pdf&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">cfg</span><span class="o">.</span><span class="n">det_id</span><span class="p">,</span> <span class="n">cfg</span><span class="o">.</span><span class="n">calibration</span><span class="o">.</span><span class="n">gain</span><span class="p">)</span>    
    <span class="n">pdf</span> <span class="o">=</span> <span class="n">PdfPages</span><span class="p">(</span> <span class="n">fname</span> <span class="p">)</span>
    
    <span class="c1">#Plotting</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">ion</span><span class="p">()</span>
    <span class="n">sns</span><span class="o">.</span><span class="n">set_context</span><span class="p">(</span><span class="s1">&#39;talk&#39;</span><span class="p">,</span> <span class="n">font_scale</span> <span class="o">=</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">colors</span> <span class="o">=</span> <span class="n">sns</span><span class="o">.</span><span class="n">color_palette</span><span class="p">(</span><span class="n">n_colors</span> <span class="o">=</span> <span class="mi">8</span><span class="p">)</span>
    
    <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">num</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mf">11.69</span><span class="p">,</span> <span class="mf">8.27</span><span class="p">),</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">100</span><span class="p">)</span>
    <span class="n">gs</span> <span class="o">=</span> <span class="n">mpl</span><span class="o">.</span><span class="n">gridspec</span><span class="o">.</span><span class="n">GridSpec</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span>
                       <span class="n">width_ratios</span><span class="o">=</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">],</span>
                       <span class="n">height_ratios</span><span class="o">=</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span>
                       <span class="p">)</span>   

    
    <span class="n">target</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">energy</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span> <span class="n">cfg</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">data</span> <span class="p">):</span>
        <span class="k">if</span> <span class="n">f</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">cfg</span><span class="o">.</span><span class="n">det_id</span> <span class="o">+</span> <span class="s1">&#39;_vcmp_&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">f</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span> <span class="n">cfg</span><span class="o">.</span><span class="n">calibration</span><span class="o">.</span><span class="n">run_id_trimmed</span> <span class="p">)</span><span class="o">+</span><span class="s1">&#39;.npz&#39;</span><span class="p">):</span>
            <span class="nb">print</span><span class="p">(</span> <span class="n">f</span> <span class="p">)</span>
            <span class="n">t</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)[</span><span class="mi">2</span><span class="p">][</span><span class="mi">0</span><span class="p">:</span><span class="mi">2</span><span class="p">]</span>
            <span class="n">target</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="n">t</span> <span class="p">)</span>
            <span class="n">energy</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="n">xrf</span><span class="p">[</span><span class="n">t</span><span class="p">]</span> <span class="p">)</span>
    
    <span class="c1">#Load global calibration and plot  </span>
    <span class="k">with</span> <span class="n">np</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="s1">&#39;calibration.npz&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">mu</span> <span class="o">=</span> <span class="n">f</span><span class="p">[</span><span class="s1">&#39;mu&#39;</span><span class="p">]</span>
        <span class="n">energy</span> <span class="o">=</span> <span class="n">f</span><span class="p">[</span><span class="s1">&#39;energy&#39;</span><span class="p">]</span>
        <span class="n">p0</span> <span class="o">=</span> <span class="n">f</span><span class="p">[</span><span class="s1">&#39;p0&#39;</span><span class="p">]</span>
        <span class="n">p1</span> <span class="o">=</span> <span class="n">f</span><span class="p">[</span><span class="s1">&#39;p1&#39;</span><span class="p">]</span>
        
        <span class="n">xx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">mu</span><span class="o">.</span><span class="n">min</span><span class="p">()</span><span class="o">*</span><span class="mf">0.8</span><span class="p">,</span> <span class="n">mu</span><span class="o">.</span><span class="n">max</span><span class="p">()</span><span class="o">*</span><span class="mf">1.2</span><span class="p">,</span> <span class="mi">100</span><span class="p">)</span>
        
        <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="n">gs</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">])</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">8</span><span class="p">):</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">mu</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">energy</span><span class="p">,</span> <span class="s1">&#39;o&#39;</span><span class="p">,</span> <span class="n">color</span> <span class="o">=</span> <span class="n">colors</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">label</span> <span class="o">=</span> <span class="s1">&#39;Chip &#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">))</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">xx</span><span class="p">,</span> <span class="n">function</span><span class="o">.</span><span class="n">pol1</span><span class="p">(</span><span class="n">xx</span><span class="p">,</span> <span class="n">p0</span><span class="p">[</span><span class="n">i</span><span class="p">],</span><span class="n">p1</span><span class="p">[</span><span class="n">i</span><span class="p">]),</span> <span class="n">color</span> <span class="o">=</span> <span class="n">colors</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span> <span class="n">fontsize</span> <span class="o">=</span> <span class="mi">8</span> <span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Vcmp&#39;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Energy [keV]&#39;</span><span class="p">)</span>

    <span class="n">hpos</span> <span class="o">=</span> <span class="mf">1.20</span>
    <span class="n">pos</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">step</span> <span class="o">=</span> <span class="o">-</span><span class="mf">0.09</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="n">hpos</span><span class="p">,</span> <span class="n">pos</span><span class="p">,</span><span class="s1">&#39;Eiger Calibration - &#39;</span><span class="o">+</span> <span class="n">cfg</span><span class="o">.</span><span class="n">det_id</span> <span class="o">+</span> <span class="s1">&#39; </span><span class="se">\&quot;</span><span class="s1">&#39;</span> <span class="o">+</span><span class="n">cfg</span><span class="o">.</span><span class="n">calibration</span><span class="o">.</span><span class="n">gain</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\&quot;</span><span class="s1">&#39;</span><span class="p">,</span>
                 <span class="n">horizontalalignment</span><span class="o">=</span><span class="s1">&#39;left&#39;</span><span class="p">,</span>
                 <span class="n">verticalalignment</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">,</span>
                 <span class="n">transform</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">transAxes</span><span class="p">,</span>
                 <span class="n">weight</span> <span class="o">=</span> <span class="s1">&#39;bold&#39;</span><span class="p">)</span>
                 
                 
    <span class="n">e_low</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span> <span class="n">p0</span><span class="o">+</span><span class="n">p1</span><span class="o">*</span><span class="n">thrange</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="p">)</span>
    <span class="n">e_high</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span> <span class="n">p0</span><span class="o">+</span><span class="n">p1</span><span class="o">*</span><span class="n">thrange</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="p">)</span>
    <span class="n">pos</span> <span class="o">-=</span> <span class="mf">0.1</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="n">hpos</span><span class="p">,</span> <span class="n">pos</span><span class="p">,</span><span class="s1">&#39;Min th: &#39;</span><span class="o">+</span> <span class="nb">str</span><span class="p">(</span> <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span> <span class="n">e_low</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span> <span class="p">)</span> <span class="o">+</span> <span class="s1">&#39; keV&#39;</span><span class="p">,</span>
                 <span class="n">horizontalalignment</span><span class="o">=</span><span class="s1">&#39;left&#39;</span><span class="p">,</span>
                 <span class="n">verticalalignment</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">,</span>
                 <span class="n">transform</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">transAxes</span><span class="p">,</span>
                 <span class="n">weight</span> <span class="o">=</span> <span class="s1">&#39;normal&#39;</span><span class="p">)</span>
    <span class="n">pos</span> <span class="o">-=</span> <span class="mf">0.09</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="n">hpos</span><span class="p">,</span> <span class="n">pos</span><span class="p">,</span><span class="s1">&#39;Max th: &#39;</span><span class="o">+</span> <span class="nb">str</span><span class="p">(</span> <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span> <span class="n">e_high</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span> <span class="p">)</span> <span class="o">+</span> <span class="s1">&#39; keV&#39;</span><span class="p">,</span>
                 <span class="n">horizontalalignment</span><span class="o">=</span><span class="s1">&#39;left&#39;</span><span class="p">,</span>
                 <span class="n">verticalalignment</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">,</span>
                 <span class="n">transform</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">transAxes</span><span class="p">,</span>
                 <span class="n">weight</span> <span class="o">=</span> <span class="s1">&#39;normal&#39;</span><span class="p">)</span>
    <span class="n">pos</span> <span class="o">-=</span> <span class="mf">0.09</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="n">hpos</span><span class="p">,</span> <span class="n">pos</span><span class="p">,</span><span class="s1">&#39;Trim E: &#39;</span><span class="o">+</span> <span class="nb">str</span><span class="p">(</span> <span class="n">xrf</span><span class="p">[</span> <span class="n">cfg</span><span class="o">.</span><span class="n">calibration</span><span class="o">.</span><span class="n">target</span> <span class="p">]</span> <span class="p">)</span> <span class="o">+</span> <span class="s1">&#39; keV&#39;</span><span class="p">,</span>
                 <span class="n">horizontalalignment</span><span class="o">=</span><span class="s1">&#39;left&#39;</span><span class="p">,</span>
                 <span class="n">verticalalignment</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">,</span>
                 <span class="n">transform</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">transAxes</span><span class="p">,</span>
                 <span class="n">weight</span> <span class="o">=</span> <span class="s1">&#39;normal&#39;</span><span class="p">)</span>
                 
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">8</span><span class="p">):</span>
        <span class="n">text</span>  <span class="o">=</span> <span class="s1">&#39;Chip &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;: &#39;</span>  <span class="o">+</span> \
                <span class="s1">&#39;p0: </span><span class="si">%6.2f</span><span class="s1"> &#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">p0</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="o">+</span> \
                <span class="s1">&#39;p1: </span><span class="si">%05.2e</span><span class="s1"> &#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">p1</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>  
        <span class="nb">print</span><span class="p">(</span> <span class="n">text</span> <span class="p">)</span>
    
    <span class="n">pos</span> <span class="o">-=</span> <span class="mf">0.09</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">8</span><span class="p">):</span>
        <span class="n">pos</span> <span class="o">-=</span> <span class="mf">0.05</span>
        <span class="n">text</span>  <span class="o">=</span> <span class="s1">&#39;Chip &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;: &#39;</span>  <span class="o">+</span> \
                <span class="s1">&#39;p0: </span><span class="si">%6.2f</span><span class="s1"> &#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">p0</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="o">+</span> \
                <span class="s1">&#39;p1: </span><span class="si">%05.2e</span><span class="s1"> &#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">p1</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>  
        <span class="n">plt</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="n">hpos</span><span class="p">,</span> <span class="n">pos</span><span class="p">,</span><span class="n">text</span><span class="p">,</span>
                 <span class="n">horizontalalignment</span><span class="o">=</span><span class="s1">&#39;left&#39;</span><span class="p">,</span>
                 <span class="n">verticalalignment</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">,</span>
                 <span class="n">transform</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">transAxes</span><span class="p">,</span>
                 <span class="n">weight</span> <span class="o">=</span> <span class="s1">&#39;normal&#39;</span><span class="p">,</span>
                 <span class="n">fontsize</span> <span class="o">=</span> <span class="mi">8</span><span class="p">,</span>
                 <span class="n">family</span> <span class="o">=</span> <span class="s1">&#39;monospace&#39;</span><span class="p">)</span>
    <span class="n">pos</span> <span class="o">-=</span> <span class="mf">0.10</span>

    <span class="n">text</span> <span class="o">=</span> <span class="s1">&#39;vrf = [</span><span class="si">{:d}</span><span class="s1">, </span><span class="si">{:d}</span><span class="s1">]&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">vrf</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">vrf</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="n">hpos</span><span class="p">,</span> <span class="n">pos</span><span class="p">,</span><span class="n">text</span><span class="p">,</span>
         <span class="n">horizontalalignment</span><span class="o">=</span><span class="s1">&#39;left&#39;</span><span class="p">,</span>
         <span class="n">verticalalignment</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">,</span>
         <span class="n">transform</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">transAxes</span><span class="p">,</span>
         <span class="n">weight</span> <span class="o">=</span> <span class="s1">&#39;normal&#39;</span><span class="p">,</span>
         <span class="n">fontsize</span> <span class="o">=</span> <span class="mi">8</span><span class="p">,</span>
         <span class="n">family</span> <span class="o">=</span> <span class="s1">&#39;monospace&#39;</span><span class="p">)</span>
    <span class="c1">#Plot threshold dispersion before and after calibration</span>
    <span class="n">bins</span> <span class="o">=</span> <span class="mi">300</span>
    <span class="n">scale</span> <span class="o">=</span> <span class="mf">3.0</span>
    <span class="n">bin_size</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">scale</span><span class="o">/</span><span class="n">bins</span><span class="o">*</span><span class="mi">1000</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">l</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;Untrimmed&#39;</span><span class="p">,</span> <span class="s1">&#39;Trimmed&#39;</span><span class="p">]</span>
    <span class="n">xlim</span> <span class="o">=</span> <span class="p">(</span><span class="n">xrf</span><span class="p">[</span> <span class="n">cfg</span><span class="o">.</span><span class="n">calibration</span><span class="o">.</span><span class="n">target</span> <span class="p">]</span><span class="o">-</span><span class="n">scale</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="n">xrf</span><span class="p">[</span> <span class="n">cfg</span><span class="o">.</span><span class="n">calibration</span><span class="o">.</span><span class="n">target</span> <span class="p">]</span><span class="o">+</span><span class="n">scale</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span>
    
    <span class="k">for</span> <span class="n">k</span><span class="p">,</span><span class="n">j</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span> <span class="p">[</span><span class="n">cfg</span><span class="o">.</span><span class="n">calibration</span><span class="o">.</span><span class="n">run_id_untrimmed</span><span class="p">,</span> <span class="n">cfg</span><span class="o">.</span><span class="n">calibration</span><span class="o">.</span><span class="n">run_id_trimmed</span><span class="p">]</span> <span class="p">):</span>
        <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="n">gs</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">fname</span> <span class="o">=</span> <span class="n">get_fit_fname</span><span class="p">(</span> <span class="n">run_id</span> <span class="o">=</span> <span class="n">j</span> <span class="p">)</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">load</span><span class="p">(</span> <span class="n">fname</span> <span class="p">)</span>
    
        <span class="n">f</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="s1">&#39;vcmp&#39;</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">8</span><span class="p">):</span>
            <span class="c1">#Trimmed distributions in DAC</span>
            <span class="k">if</span> <span class="n">j</span> <span class="o">==</span> <span class="n">cfg</span><span class="o">.</span><span class="n">calibration</span><span class="o">.</span><span class="n">run_id_trimmed</span><span class="p">:</span>
                <span class="n">c</span><span class="p">,</span><span class="n">h</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;mu&#39;</span><span class="p">][</span><span class="n">mask</span><span class="o">.</span><span class="n">chip</span><span class="p">[</span><span class="n">i</span><span class="p">]],</span> <span class="n">xmin</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">xmax</span> <span class="o">=</span> <span class="mi">2000</span><span class="p">,</span> <span class="n">bins</span> <span class="o">=</span> <span class="n">bins</span><span class="p">)</span>
                <span class="n">x</span><span class="p">,</span><span class="n">y</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">getHist</span><span class="p">(</span><span class="n">h</span><span class="p">,</span> <span class="n">edge</span> <span class="o">=</span> <span class="s1">&#39;high&#39;</span><span class="p">)</span>                      
                <span class="n">label</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%d</span><span class="s1">: $\mu$:</span><span class="si">%d</span><span class="s1"> $\sigma$:</span><span class="si">%.2f</span><span class="s1"> &#39;</span><span class="o">%</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">h</span><span class="o">.</span><span class="n">GetMean</span><span class="p">(),</span> <span class="n">h</span><span class="o">.</span><span class="n">GetStdDev</span><span class="p">())</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">,</span> <span class="n">ls</span> <span class="o">=</span> <span class="s1">&#39;steps&#39;</span><span class="p">,</span> <span class="n">label</span> <span class="o">=</span> <span class="n">label</span><span class="p">,</span> <span class="n">color</span> <span class="o">=</span> <span class="n">colors</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{:.0f}</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span> <span class="n">h</span><span class="o">.</span><span class="n">GetMean</span><span class="p">())</span> <span class="p">)</span>

        <span class="n">f</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
                
          
        <span class="c1">#Vcmp plot notation</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span> <span class="n">fontsize</span> <span class="o">=</span> <span class="mi">8</span><span class="p">,</span> <span class="n">loc</span> <span class="o">=</span> <span class="s1">&#39;upper left&#39;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Vcmp&#39;</span><span class="p">)</span>
        
        
        <span class="c1">#Empty histogram</span>
        <span class="n">c</span><span class="p">,</span><span class="n">h</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">hist</span><span class="p">([</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">xmin</span> <span class="o">=</span> <span class="n">xlim</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">xmax</span> <span class="o">=</span> <span class="n">xlim</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">bins</span> <span class="o">=</span> <span class="n">bins</span><span class="p">)</span>
    
        <span class="c1">#Fill with pixel data</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">8</span><span class="p">):</span>
            <span class="n">tmp</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;mu&#39;</span><span class="p">][</span><span class="n">mask</span><span class="o">.</span><span class="n">chip</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span><span class="o">*</span><span class="n">p1</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">+</span><span class="n">p0</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">pixel</span> <span class="ow">in</span> <span class="n">tmp</span><span class="o">.</span><span class="n">flat</span><span class="p">:</span>
                <span class="n">h</span><span class="o">.</span><span class="n">Fill</span><span class="p">(</span><span class="n">pixel</span><span class="p">)</span>
                
        <span class="c1">#Plot energy data</span>
        <span class="n">x</span><span class="p">,</span><span class="n">y</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">getHist</span><span class="p">(</span><span class="n">h</span><span class="p">,</span> <span class="n">edge</span> <span class="o">=</span> <span class="s1">&#39;high&#39;</span><span class="p">)</span>
        <span class="n">mean</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span> <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span> <span class="n">h</span><span class="o">.</span><span class="n">GetMean</span><span class="p">(),</span> <span class="mi">1</span> <span class="p">)</span> <span class="p">)</span>
        <span class="n">sigma</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span> <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">h</span><span class="o">.</span><span class="n">GetStdDev</span><span class="p">()</span><span class="o">*</span><span class="mi">1000</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="p">)</span>
        <span class="n">label</span> <span class="o">=</span> <span class="n">l</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">+</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">$\mu$: &#39;</span> <span class="o">+</span> <span class="n">mean</span> <span class="o">+</span> <span class="s1">&#39;keV</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">+</span> <span class="sa">r</span><span class="s1">&#39;$\sigma$: &#39;</span> <span class="o">+</span> <span class="n">sigma</span> <span class="o">+</span><span class="s1">&#39; eV&#39;</span>
        
        <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="n">gs</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">fill_between</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">,</span> <span class="n">step</span> <span class="o">=</span> <span class="s1">&#39;pre&#39;</span><span class="p">,</span> <span class="n">label</span> <span class="o">=</span> <span class="n">label</span><span class="p">,</span> <span class="n">color</span> <span class="o">=</span> <span class="n">colors</span><span class="p">[</span><span class="n">k</span><span class="p">])</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">xlim</span><span class="p">(</span> <span class="n">xlim</span> <span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Energy [keV]&#39;</span><span class="p">)</span>

    <span class="n">pdf</span><span class="o">.</span><span class="n">savefig</span><span class="p">()</span>
    
    <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">num</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mf">11.69</span><span class="p">,</span> <span class="mf">8.27</span><span class="p">),</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">100</span><span class="p">)</span>
    <span class="n">gs</span> <span class="o">=</span> <span class="n">mpl</span><span class="o">.</span><span class="n">gridspec</span><span class="o">.</span><span class="n">GridSpec</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span>
                       <span class="n">width_ratios</span><span class="o">=</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">],</span>
                       <span class="n">height_ratios</span><span class="o">=</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span>
                       <span class="p">)</span>   
    
    <span class="n">fname</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{:s}</span><span class="s1">_vcmp_</span><span class="si">{:s}</span><span class="s1">XRF_</span><span class="si">{:d}</span><span class="s1">.npz&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span> <span class="n">cfg</span><span class="o">.</span><span class="n">det_id</span><span class="p">,</span> <span class="n">cfg</span><span class="o">.</span><span class="n">calibration</span><span class="o">.</span><span class="n">target</span><span class="p">,</span> <span class="n">cfg</span><span class="o">.</span><span class="n">calibration</span><span class="o">.</span><span class="n">run_id</span> <span class="p">)</span>
    <span class="k">with</span> <span class="n">np</span><span class="o">.</span><span class="n">load</span><span class="p">(</span> <span class="n">fname</span> <span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">f</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">]</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">f</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">]</span>      
    
    <span class="n">ax1</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="n">gs</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">3</span><span class="p">])</span>
    <span class="n">ax2</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="n">gs</span><span class="p">[</span><span class="mi">3</span><span class="p">:</span><span class="mi">6</span><span class="p">])</span>

    
    <span class="c1">#Clean up data</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span> <span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="p">):</span>
        <span class="n">data</span><span class="p">[:,:,</span><span class="n">i</span><span class="p">][</span><span class="n">data</span><span class="p">[:,:,</span><span class="n">i</span><span class="p">]</span><span class="o">&gt;</span> <span class="mi">3</span><span class="o">*</span> <span class="n">data</span><span class="p">[:,:,</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()]</span> <span class="o">=</span> <span class="mi">0</span>
    

    
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">8</span><span class="p">):</span>
        <span class="n">chip_slice</span> <span class="o">=</span> <span class="n">mask</span><span class="o">.</span><span class="n">chip</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="p">[</span><span class="nb">slice</span><span class="p">(</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">),</span> <span class="mi">1</span> <span class="p">)]</span>
        <span class="n">y</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">chip_slice</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span> <span class="o">=</span> <span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span> <span class="o">=</span> <span class="mi">0</span><span class="p">)</span>
        <span class="n">xx</span> <span class="o">=</span> <span class="n">p0</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">+</span><span class="n">p1</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">*</span><span class="n">x</span>
        <span class="n">ax1</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">xx</span><span class="p">,</span><span class="n">y</span><span class="p">,</span> <span class="n">label</span> <span class="o">=</span> <span class="s1">&#39;Chip: </span><span class="si">{:d}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">i</span><span class="p">))</span>
        
        <span class="n">y_gradient</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">gradient</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>
        <span class="n">y_gradient</span> <span class="o">/=</span> <span class="n">y_gradient</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
        <span class="n">ax2</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">xx</span><span class="p">,</span> <span class="n">y_gradient</span><span class="p">,</span> <span class="n">label</span> <span class="o">=</span> <span class="s1">&#39;Chip: </span><span class="si">{:d}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">i</span><span class="p">))</span>
        <span class="n">ax2</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mf">1.1</span><span class="p">)</span>

    <span class="n">ax1</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span> <span class="n">loc</span> <span class="o">=</span> <span class="s1">&#39;upper right&#39;</span> <span class="p">)</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span> <span class="s1">&#39;Energy [keV]&#39;</span> <span class="p">)</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39; Counts [1] &#39;</span><span class="p">)</span>
    
    <span class="n">ax2</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span> <span class="n">loc</span> <span class="o">=</span> <span class="s1">&#39;upper right&#39;</span> <span class="p">)</span>
    <span class="n">ax2</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span> <span class="s1">&#39;Energy [keV]&#39;</span> <span class="p">)</span>
    <span class="n">ax2</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39; Counts [a.u.] &#39;</span><span class="p">)</span>


    <span class="n">fname</span> <span class="o">=</span> <span class="n">get_trimbit_fname</span><span class="p">()</span> <span class="o">+</span> <span class="s1">&#39;.npz&#39;</span>    
    <span class="k">with</span> <span class="n">np</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">fname</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">image</span> <span class="o">=</span> <span class="n">f</span><span class="p">[</span><span class="s1">&#39;trimbits&#39;</span><span class="p">]</span>

    <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="n">gs</span><span class="p">[</span><span class="mi">6</span><span class="p">:</span><span class="mi">10</span><span class="p">])</span>
    <span class="n">im</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span> <span class="n">image</span><span class="p">,</span> <span class="n">cmap</span> <span class="o">=</span> <span class="s1">&#39;coolwarm&#39;</span><span class="p">,</span> <span class="n">origin</span> <span class="o">=</span> <span class="s1">&#39;lower&#39;</span><span class="p">,</span> <span class="n">interpolation</span> <span class="o">=</span> <span class="s1">&#39;nearest&#39;</span> <span class="p">)</span>
    <span class="n">im</span><span class="o">.</span><span class="n">set_clim</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">63</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Trimbit map&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
    
    <span class="n">divider</span> <span class="o">=</span> <span class="n">make_axes_locatable</span><span class="p">(</span><span class="n">ax</span><span class="p">)</span>
    <span class="n">cax</span> <span class="o">=</span> <span class="n">divider</span><span class="o">.</span><span class="n">append_axes</span><span class="p">(</span><span class="s2">&quot;right&quot;</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="s2">&quot;5%&quot;</span><span class="p">,</span> <span class="n">pad</span><span class="o">=</span><span class="mf">0.05</span><span class="p">)</span>
    
    <span class="n">cb</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">mappable</span> <span class="o">=</span> <span class="n">im</span><span class="p">,</span> <span class="n">cax</span> <span class="o">=</span> <span class="n">cax</span><span class="p">)</span>
    
    <span class="n">ax</span> <span class="o">=</span>  <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="n">gs</span><span class="p">[</span><span class="mi">10</span><span class="p">:</span><span class="mi">12</span><span class="p">])</span>
    <span class="n">c</span><span class="p">,</span><span class="n">h</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">xmin</span> <span class="o">=</span> <span class="o">-.</span><span class="mi">5</span><span class="p">,</span> <span class="n">xmax</span> <span class="o">=</span> <span class="mf">63.5</span><span class="p">,</span> <span class="n">bins</span> <span class="o">=</span> <span class="mi">64</span><span class="p">)</span>
    <span class="n">x0</span><span class="p">,</span><span class="n">y0</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">getHist</span><span class="p">(</span><span class="n">h</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x0</span><span class="p">,</span><span class="n">y0</span><span class="o">/</span><span class="n">y0</span><span class="o">.</span><span class="n">max</span><span class="p">(),</span> <span class="n">ls</span> <span class="o">=</span> <span class="s1">&#39;steps&#39;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">fill_between</span><span class="p">(</span><span class="n">x0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">y0</span><span class="o">/</span><span class="n">y0</span><span class="o">.</span><span class="n">max</span><span class="p">(),</span> <span class="n">step</span> <span class="o">=</span> <span class="s1">&#39;pre&#39;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">64</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Trimbit [1]&#39;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Pixels [a.u.]&#39;</span><span class="p">)</span>  
    <span class="n">ax</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span> <span class="mi">0</span><span class="p">,</span> <span class="mf">1.1</span> <span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
    <span class="n">pdf</span><span class="o">.</span><span class="n">savefig</span><span class="p">()</span>
    <span class="n">pdf</span><span class="o">.</span><span class="n">close</span><span class="p">()</span></div>
    
<div class="viewcode-block" id="write_calibration_files"><a class="viewcode-back" href="../../sls_detector_tools.html#sls_detector_tools.calibration.write_calibration_files">[docs]</a><span class="k">def</span> <span class="nf">write_calibration_files</span><span class="p">(</span><span class="n">afs</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">loc</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">afs_overwrite</span> <span class="o">=</span> <span class="kc">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Write Eiger calibration files and copy to the settingsdir</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">source</span> <span class="o">=</span> <span class="n">cfg</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">data</span>
    <span class="n">destination</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span> <span class="n">cfg</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">settingsdir</span><span class="p">,</span> <span class="n">cfg</span><span class="o">.</span><span class="n">calibration</span><span class="o">.</span><span class="n">gain</span> <span class="p">)</span> 
    <span class="n">calibration</span> <span class="o">=</span> <span class="n">source</span> <span class="o">+</span> <span class="s1">&#39;/calibration.npz&#39;</span>
    

    <span class="c1">#-----------------------------------------------------------Trimbits</span>

    <span class="nb">print</span><span class="p">(</span> <span class="s1">&#39;*** Processing trimbit files ***&#39;</span><span class="p">)</span>
    <span class="c1">#find trimbit files</span>
    <span class="n">top_trim</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span> <span class="n">source</span><span class="p">,</span> <span class="s1">&#39;</span><span class="si">{:s}</span><span class="s1">_</span><span class="si">{:s}</span><span class="s1">_</span><span class="si">{:s}</span><span class="s1">.sn</span><span class="si">{:s}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">cfg</span><span class="o">.</span><span class="n">det_id</span><span class="p">,</span> <span class="n">cfg</span><span class="o">.</span><span class="n">calibration</span><span class="o">.</span><span class="n">target</span><span class="p">,</span> <span class="n">cfg</span><span class="o">.</span><span class="n">calibration</span><span class="o">.</span><span class="n">gain</span><span class="p">,</span> <span class="n">cfg</span><span class="o">.</span><span class="n">top</span><span class="p">[</span><span class="mi">3</span><span class="p">:])</span> <span class="p">)</span>
    <span class="n">bottom_trim</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span> <span class="n">source</span><span class="p">,</span> <span class="s1">&#39;</span><span class="si">{:s}</span><span class="s1">_</span><span class="si">{:s}</span><span class="s1">_</span><span class="si">{:s}</span><span class="s1">.sn</span><span class="si">{:s}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">cfg</span><span class="o">.</span><span class="n">det_id</span><span class="p">,</span> <span class="n">cfg</span><span class="o">.</span><span class="n">calibration</span><span class="o">.</span><span class="n">target</span><span class="p">,</span> <span class="n">cfg</span><span class="o">.</span><span class="n">calibration</span><span class="o">.</span><span class="n">gain</span><span class="p">,</span> <span class="n">cfg</span><span class="o">.</span><span class="n">bottom</span><span class="p">[</span><span class="mi">3</span><span class="p">:])</span> <span class="p">)</span>
    
    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span> <span class="n">top_trim</span> <span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span> <span class="s1">&#39;Top trimbit file found&#39;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">IOError</span><span class="p">(</span><span class="s1">&#39;top trimfile not found&#39;</span><span class="p">)</span>
        
    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span> <span class="n">bottom_trim</span> <span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span> <span class="s1">&#39;Bottom trimfile found&#39;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">IOError</span><span class="p">(</span><span class="s1">&#39;bottom trimfile not found&#39;</span><span class="p">)</span>   
        
    <span class="c1">#check output directory</span>
    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span> <span class="n">destination</span> <span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span> <span class="s1">&#39;settingsdir found&#39;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">IOError</span><span class="p">(</span><span class="s1">&#39;settingsdir not found&#39;</span><span class="p">)</span>
        

        
    <span class="c1">#copy trimbit files</span>
    <span class="n">fname</span> <span class="o">=</span> <span class="n">destination</span> <span class="o">+</span> <span class="s1">&#39;/noise.sn</span><span class="si">{:s}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span> <span class="n">cfg</span><span class="o">.</span><span class="n">top</span><span class="p">[</span><span class="mi">3</span><span class="p">:]</span> <span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span> <span class="s1">&#39;Writing:&#39;</span><span class="p">,</span> <span class="n">fname</span><span class="p">)</span>
    <span class="n">shutil</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span> <span class="n">top_trim</span><span class="p">,</span> <span class="n">fname</span><span class="p">)</span>
    <span class="n">fname</span> <span class="o">=</span> <span class="n">destination</span> <span class="o">+</span> <span class="s1">&#39;/noise.sn</span><span class="si">{:s}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span> <span class="n">cfg</span><span class="o">.</span><span class="n">bottom</span><span class="p">[</span><span class="mi">3</span><span class="p">:]</span> <span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span> <span class="s1">&#39;Writing:&#39;</span><span class="p">,</span> <span class="n">fname</span><span class="p">)</span>
    <span class="n">shutil</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span> <span class="n">bottom_trim</span><span class="p">,</span> <span class="n">fname</span><span class="p">)</span>
    
    <span class="k">if</span> <span class="n">afs</span><span class="p">:</span>
        <span class="n">afs_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span> <span class="n">cfg</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">afs_calibration</span><span class="p">,</span> <span class="s1">&#39;</span><span class="si">{:s}</span><span class="s1">-</span><span class="si">{:s}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">cfg</span><span class="o">.</span><span class="n">det_id</span><span class="p">,</span> <span class="n">loc</span><span class="p">),</span> <span class="n">cfg</span><span class="o">.</span><span class="n">calibration</span><span class="o">.</span><span class="n">gain</span> <span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Saving to AFS: &#39;</span><span class="p">,</span> <span class="n">afs_path</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span> <span class="n">afs_path</span> <span class="p">):</span>
            <span class="k">pass</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span> <span class="n">afs_path</span> <span class="p">)</span>
        <span class="n">dest_fname</span> <span class="o">=</span> <span class="n">afs_path</span> <span class="o">+</span> <span class="s1">&#39;/noise.sn</span><span class="si">{:s}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>  <span class="n">cfg</span><span class="o">.</span><span class="n">top</span><span class="p">[</span><span class="mi">3</span><span class="p">:]</span> <span class="p">)</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">dest_fname</span><span class="p">):</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">afs_overwrite</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">IOError</span><span class="p">(</span><span class="s1">&#39;File already exists&#39;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span> <span class="s1">&#39;Writing:&#39;</span><span class="p">,</span> <span class="n">dest_fname</span><span class="p">)</span>
        <span class="n">shutil</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span> <span class="n">top_trim</span><span class="p">,</span> <span class="n">dest_fname</span><span class="p">)</span>
        
        <span class="n">dest_fname</span> <span class="o">=</span> <span class="n">afs_path</span> <span class="o">+</span> <span class="s1">&#39;/noise.sn</span><span class="si">{:s}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>  <span class="n">cfg</span><span class="o">.</span><span class="n">bottom</span><span class="p">[</span><span class="mi">3</span><span class="p">:]</span> <span class="p">)</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">dest_fname</span><span class="p">):</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">afs_overwrite</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">IOError</span><span class="p">(</span><span class="s1">&#39;File already exists&#39;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span> <span class="s1">&#39;Writing:&#39;</span><span class="p">,</span> <span class="n">dest_fname</span><span class="p">)</span>
        <span class="n">shutil</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span> <span class="n">top_trim</span><span class="p">,</span> <span class="n">dest_fname</span><span class="p">)</span>
        
    <span class="c1">#------------------------------------------------------------Calibration</span>
    <span class="c1">#find calibration files</span>
    <span class="nb">print</span><span class="p">(</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">*** Processing calibration ***&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span> <span class="n">calibration</span> <span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span> <span class="s1">&#39;calibration file found&#39;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">IOError</span><span class="p">(</span><span class="s1">&#39;calibration file not found&#39;</span><span class="p">)</span>
    
    <span class="c1">#Write text files</span>
    <span class="k">with</span> <span class="n">np</span><span class="o">.</span><span class="n">load</span><span class="p">(</span> <span class="n">calibration</span> <span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">p0</span> <span class="o">=</span> <span class="n">f</span><span class="p">[</span><span class="s1">&#39;p0&#39;</span><span class="p">]</span>
        <span class="n">p1</span> <span class="o">=</span> <span class="n">f</span><span class="p">[</span><span class="s1">&#39;p1&#39;</span><span class="p">]</span>
        
    <span class="n">k</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span> <span class="mi">1</span><span class="o">/</span><span class="n">p1</span> <span class="p">)</span>
    <span class="n">m</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span> <span class="n">p0</span><span class="o">/</span><span class="n">p1</span> <span class="p">)</span>   
    
    <span class="c1">#Top</span>
    <span class="n">fname</span> <span class="o">=</span> <span class="s1">&#39;calibration.sn</span><span class="si">{:s}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">cfg</span><span class="o">.</span><span class="n">top</span><span class="p">[</span><span class="mi">3</span><span class="p">:])</span>
    <span class="n">pathname</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span> <span class="n">destination</span><span class="p">,</span> <span class="n">fname</span> <span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span> <span class="s1">&#39;Writing:&#39;</span><span class="p">,</span> <span class="n">pathname</span><span class="p">)</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span> <span class="n">pathname</span> <span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">4</span><span class="p">):</span>
            <span class="n">line</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%.2f</span><span class="s1"> </span><span class="si">%.2f</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">m</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">k</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span> <span class="n">line</span> <span class="p">)</span>
    <span class="k">if</span> <span class="n">afs</span><span class="p">:</span>
        <span class="n">afs_pathname</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span> <span class="n">afs_path</span><span class="p">,</span> <span class="n">fname</span> <span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span> <span class="s1">&#39;Writing:&#39;</span><span class="p">,</span> <span class="n">afs_pathname</span><span class="p">)</span>
        <span class="n">shutil</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span> <span class="n">pathname</span><span class="p">,</span> <span class="n">afs_pathname</span> <span class="p">)</span>
    <span class="c1">#Bottom</span>
    <span class="n">fname</span> <span class="o">=</span> <span class="s1">&#39;calibration.sn</span><span class="si">{:s}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">cfg</span><span class="o">.</span><span class="n">bottom</span><span class="p">[</span><span class="mi">3</span><span class="p">:])</span>
    <span class="n">pathname</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">destination</span><span class="p">,</span> <span class="n">fname</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span> <span class="s1">&#39;Writing:&#39;</span><span class="p">,</span> <span class="n">pathname</span><span class="p">)</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span> <span class="n">pathname</span> <span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>   
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">7</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">):</span>
            <span class="n">line</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%.2f</span><span class="s1"> </span><span class="si">%.2f</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">m</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">k</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span> <span class="n">line</span> <span class="p">)</span>
            
    <span class="k">if</span> <span class="n">afs</span><span class="p">:</span>
        <span class="n">afs_pathname</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span> <span class="n">afs_path</span><span class="p">,</span> <span class="n">fname</span> <span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span> <span class="s1">&#39;Writing:&#39;</span><span class="p">,</span> <span class="n">afs_pathname</span><span class="p">)</span>
        <span class="n">shutil</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span> <span class="n">pathname</span><span class="p">,</span> <span class="n">afs_pathname</span> <span class="p">)</span>
        
    <span class="k">if</span> <span class="n">afs</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">*** Copying calibration report ***&#39;</span><span class="p">)</span>
        <span class="c1">#T38_veryhighgain_calibration_report.pdf</span>
        <span class="n">fname</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{:s}</span><span class="s1">_</span><span class="si">{:s}</span><span class="s1">_calibration_report.pdf&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">cfg</span><span class="o">.</span><span class="n">det_id</span><span class="p">,</span> <span class="n">cfg</span><span class="o">.</span><span class="n">calibration</span><span class="o">.</span><span class="n">gain</span><span class="p">)</span>
        <span class="n">pathname</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span> <span class="n">source</span><span class="p">,</span> <span class="n">fname</span> <span class="p">)</span> 
        <span class="n">afs_pathname</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">afs_path</span><span class="p">)[</span><span class="mi">0</span><span class="p">],</span> <span class="n">fname</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span> <span class="s1">&#39;Writing:&#39;</span><span class="p">,</span> <span class="n">afs_pathname</span><span class="p">)</span>
        <span class="n">shutil</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span> <span class="n">pathname</span><span class="p">,</span> <span class="n">afs_pathname</span> <span class="p">)</span></div>
</pre></div>

           </div>
           <div class="articleComments">
            
           </div>
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2017, SLS Detector Group.

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  

    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'../../',
            VERSION:'pre-alpha',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'.html',
            HAS_SOURCE:  true,
            SOURCELINK_SUFFIX: '.txt'
        };
    </script>
      <script type="text/javascript" src="../../_static/jquery.js"></script>
      <script type="text/javascript" src="../../_static/underscore.js"></script>
      <script type="text/javascript" src="../../_static/doctools.js"></script>
      <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>

  

  
  
    <script type="text/javascript" src="../../_static/js/theme.js"></script>
  

  
  
  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.StickyNav.enable();
      });
  </script>
   

</body>
</html>